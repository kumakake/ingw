# 作業ログ 2024-12-20

## 概要
利用者No自動生成機能の実装とWordPressプラグインのライセンス検証改善

---

## 1. 利用者No自動生成機能

### 要件
- 利用者No: `YYMM999999`形式（例: 2412123456）
- ユーザー登録時に自動生成
- 999999は6桁のランダム数値
- 重複不可（UNIQUE制約）
- 利用者氏名: ログインID（login_account）を表示

### 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `db/schema.sql` | usersテーブルに`user_no VARCHAR(10) UNIQUE`追加 |
| `src/models/User.js` | `generateUserNo()`メソッド追加、`create()`で自動生成 |
| `src/models/License.js` | `getAll()`で`u.user_no`, `u.login_account AS user_name`を取得 |
| `public/license.html` | 手動入力フィールド削除、編集機能削除 |

### User.js - generateUserNo()メソッド
```javascript
static async generateUserNo() {
  const now = new Date();
  const yymm = String(now.getFullYear()).slice(-2) +
               String(now.getMonth() + 1).padStart(2, '0');

  let userNo;
  let exists = true;
  while (exists) {
    const random = String(Math.floor(Math.random() * 1000000)).padStart(6, '0');
    userNo = yymm + random;
    const check = await db.query(
      'SELECT 1 FROM users WHERE user_no = $1', [userNo]
    );
    exists = check.rows.length > 0;
  }
  return userNo;
}
```

### 本番サーバーでの対応
```sql
-- 1. usersテーブルにカラム追加
ALTER TABLE users ADD COLUMN user_no VARCHAR(10) UNIQUE;

-- 2. 既存ユーザーにuser_noを付与
UPDATE users
SET user_no = TO_CHAR(created_at, 'YYMM') || LPAD(FLOOR(RANDOM() * 1000000)::TEXT, 6, '0')
WHERE user_no IS NULL;
```

### Docker環境での実行結果
```
 id | login_account |  user_no
----+---------------+------------
  1 | testuser01    | 2511968611
  2 | kuma01        | 2512853705
```

---

## 2. WordPressプラグイン ライセンス検証改善

### 問題
- ライセンス検証が失敗した状態で、同じキーで再保存しても検証がスキップされる
- ユーザーは一度ライセンスキーを空白にして保存し、再度入力する必要があった

### 原因
`class-in-gateway-admin.php`の実装:
```php
// 変更前: ライセンスキーが変更された場合のみ検証
if ($new_license_key !== $old_license_key) {
```

### 解決策
ライセンスが無効状態の場合も再検証するように修正:
```php
// 変更後: ライセンスキーが変更された場合、または無効状態の場合は検証
if ($new_license_key !== $old_license_key || !$old_license_valid) {
```

### 変更ファイル
- `/Users/kumakake/docker/kumakake/instagram/wordpress/wp-content/plugins/in-gateway/includes/class-in-gateway-admin.php`

---

## 3. トラブルシューティング

### ライセンス一覧エラー
**エラー**: `column u.user_no does not exist`

**原因**: DBにuser_noカラムが未追加

**対応**: Docker環境でALTER TABLE実行
```bash
docker-compose exec -T db psql -U postgres -d instagram_oauth -c \
  "ALTER TABLE users ADD COLUMN user_no VARCHAR(10) UNIQUE;"
```

### ライセンス認証エラー（WordPress）
**エラー**: `このライセンスは別のドメインで使用されています`

**原因**: curlテスト時に`test.example.com`ドメインで有効化されていた

**対応**: ドメインをリセット
```bash
docker-compose exec -T db psql -U postgres -d instagram_oauth -c \
  "UPDATE licenses SET domain = NULL, activated_at = NULL WHERE license_key = 'QIMZYZ8BWKTJH2W4X64PIV8OW0JOUBG8';"
```

---

## 4. 確認済み動作

- [x] 新規ユーザー登録時にuser_noが自動生成される
- [x] ライセンス一覧で利用者No（users.user_no）と利用者氏名（users.login_account）が表示される
- [x] WordPressプラグインでライセンス認証が成功する
- [x] ライセンス無効状態でも再検証が実行される

---

## 5. 接続テストメッセージ改善

### 変更内容
接続テスト成功時にサブスクリプション必要の注意書きを追加

### 変更ファイル
- `wordpress/wp-content/plugins/in-gateway/includes/class-in-gateway-api.php`

```php
// 変更前
'接続成功！Instagram User ID: %s'

// 変更後
'接続成功！Instagram User ID: %s ※投稿にはサブスクリプション登録が必要です'
```

---

## 6. 自動投稿テスト

### 結果
- ライセンス認証: 成功
- サブスクリプション検証: 成功（trialing状態で動作確認）
- Instagram投稿: 開発環境では不可

### 開発環境での制限
Instagram Graph APIは**外部からアクセス可能な公開URL**が必要なため、`localhost`の画像はInstagramからアクセスできない。

**エラーメッセージ**:
```
Only photo or video can be accepted as media type.
```

本番環境では問題なく動作する見込み。

---

## 7. デプロイ手順

### 7.1 マイグレーションファイル
```
db/migrations/001_add_user_no_to_users.sql
```

### 7.2 本番環境での実行手順

#### Step 1: コードのデプロイ
```bash
git pull origin main
npm install  # 依存関係の更新がある場合
```

#### Step 2: DBマイグレーション実行
```bash
psql -U postgres -d instagram_oauth -f db/migrations/001_add_user_no_to_users.sql
```

または直接実行:
```sql
-- カラム追加
ALTER TABLE users ADD COLUMN IF NOT EXISTS user_no VARCHAR(10) UNIQUE;

-- 既存ユーザーにuser_no付与
UPDATE users
SET user_no = TO_CHAR(created_at, 'YYMM') || LPAD(FLOOR(RANDOM() * 1000000)::TEXT, 6, '0')
WHERE user_no IS NULL;

-- 確認
SELECT id, login_account, user_no FROM users;
```

#### Step 3: アプリケーション再起動
```bash
pm2 restart instagram-oauth  # または使用しているプロセスマネージャー
```

#### Step 4: 動作確認
- ライセンス管理画面で利用者No・利用者氏名が表示されることを確認
- 新規ユーザー登録時にuser_noが自動生成されることを確認

---

## 8. 変更ファイル一覧

| ファイル | 変更種別 | 内容 |
|---------|---------|------|
| `db/schema.sql` | 修正 | user_noカラム追加 |
| `db/migrations/001_add_user_no_to_users.sql` | 新規 | マイグレーションスクリプト |
| `src/models/User.js` | 修正 | generateUserNo()追加、create()修正 |
| `src/models/License.js` | 修正 | getAll()でusers.user_no取得 |
| `public/license.html` | 修正 | 手動入力・編集機能削除 |
| `wordpress/.../class-in-gateway-admin.php` | 修正 | ライセンス再検証条件追加 |
| `wordpress/.../class-in-gateway-api.php` | 修正 | 接続テストメッセージ改善 |

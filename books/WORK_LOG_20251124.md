# 作業ログ 2024-11-24

## 概要
Instagram Gateway本番サーバー設定とライセンス管理の認証保護実装

---

## 1. OAuthコールバックのリダイレクト先変更

### 問題
- 本番サーバー（https://ingw.ai-trans-labo.fun/）でOAuth認証後、`/`にリダイレクトされるが「Cannot GET /」エラー
- nginxがルートの`index.html`を先に処理し、Expressの`public/index.html`が表示されない

### 対応
1. `public/index.html` → `public/geting.html`にリネーム
2. `src/controllers/authController.js`のリダイレクト先を変更
   - `/?success=true&data=...` → `/geting.html?success=true&data=...`
   - `/?error=...` → `/geting.html?error=...`（3箇所）

### 変更ファイル
- `public/geting.html`（リネーム）
- `src/controllers/authController.js`

---

## 2. ライセンステーブルのカラム追加

### 問題
```
error: リレーション"licenses"の列"user_no"は存在しません
```
`License.js`で使用している`user_no`、`user_name`カラムが`db/schema.sql`に未定義

### 対応
`db/schema.sql`に以下のカラムを追加:
```sql
user_no VARCHAR(255),
user_name VARCHAR(255),
```

### 本番サーバーでの対応
```sql
ALTER TABLE licenses ADD COLUMN user_no VARCHAR(255);
ALTER TABLE licenses ADD COLUMN user_name VARCHAR(255);
```

---

## 3. ライセンス管理の認証保護

### 要件
- OAuthサービス（`/auth/*`, `/api/instagram/*`）は公開
- ライセンス管理（`/api/license/*`）は認証必須

### 実装内容

#### 新規作成: `src/middleware/adminAuth.js`
Basic認証ミドルウェア
- 環境変数`ADMIN_USERNAME`、`ADMIN_PASSWORD`で認証情報を管理
- 認証失敗時は401レスポンス

#### 変更: `src/app.js`
```javascript
const adminAuth = require('./middleware/adminAuth');
// ...
app.use('/api/license', adminAuth, licenseRoutes);
```

#### 変更: `.env.example`
```
# Admin Authentication (for license management)
ADMIN_USERNAME=admin
ADMIN_PASSWORD=your_secure_password
```

### 認証フロー
```
公開                          認証必要
────────────────────────────────────────
/                 (説明ページ)
/geting.html      (OAuth取得)
/auth/*           (OAuth API)
/api/instagram/*  (Instagram API)
                                  /license.html
                                  /api/license/*
```

---

## 4. サービス説明ページ作成

### 新規作成: `public/index.html`

#### 構成
- サービス概要
- 主な機能
- 事前準備（必須）
  1. Facebookページを作成
  2. Instagramをビジネスアカウントに切り替え
  3. FacebookページとInstagramをリンク
- ご利用の流れ
- 必要条件
- ボタン
  - OAuth認証を開始 → `/geting.html`
  - 管理者ログイン → `/license.html`（Basic認証）

---

## 変更ファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `public/index.html` | 新規：サービス説明ページ |
| `public/geting.html` | リネーム（旧: index.html） |
| `src/controllers/authController.js` | リダイレクト先変更 |
| `src/middleware/adminAuth.js` | 新規：Basic認証ミドルウェア |
| `src/app.js` | ライセンスルートに認証適用 |
| `db/schema.sql` | user_no, user_nameカラム追加 |
| `.env.example` | ADMIN_USERNAME, ADMIN_PASSWORD追加 |

---

## 本番デプロイ手順

1. ファイルをデプロイ

2. 環境変数を追加（`.env`）:
```
ADMIN_USERNAME=admin
ADMIN_PASSWORD=<安全なパスワード>
```

3. DBカラム追加:
```sql
ALTER TABLE licenses ADD COLUMN user_no VARCHAR(255);
ALTER TABLE licenses ADD COLUMN user_name VARCHAR(255);
```

4. PM2再起動:
```bash
pm2 restart in-gateway-api
```

---

## 動作確認結果

- [x] OAuth認証フロー正常動作
- [x] WordPress接続成功（Instagram User ID: 17841477936988563）
- [ ] ライセンス管理の認証（本番デプロイ後確認）

# 作業ログ 2024-12-20 (続き)

## 概要
Instagram投稿エラーの調査・修正、投稿試行ログ機能の実装

---

## 1. Instagram投稿エラー「Media ID is not available」の調査

### 問題
本番環境でInstagram投稿時に以下のエラーが発生：
```
Instagram post error: Error: Instagram投稿に失敗しました: メディア公開に失敗: Media ID is not available
```

### 原因分析
Instagram Graph APIの `media_publish` エンドポイントが、メディアコンテナのIDを返さなかった。
考えられる原因：
- メディアコンテナが準備完了していない
- 画像URLがInstagramからアクセスできない
- ネットワークタイミングの問題

### 対応
`src/services/instagramPostService.js` にデバッグログを追加：

```javascript
// createMediaContainer() - コンテナ作成時
console.log('[IG Container Create] Response:', JSON.stringify(response.data));

// waitForContainerReady() - ステータス確認時
console.log(`[IG Container] ID: ${containerId}, Status: ${status}, Attempt: ${attempt + 1}/${maxAttempts}`);

// publishContainer() - 公開時
console.log('[IG Publish] Response:', JSON.stringify(response.data));
```

また、ステータスが `undefined` や `EXPIRED` の場合のエラーハンドリングを追加。

### 結果
再試行で投稿成功：
```
[IG Container Create] Response: {"id":"17853829353597900"}
[IG Container] ID: 17853829353597900, Status: IN_PROGRESS, Attempt: 1/30
[IG Container] ID: 17853829353597900, Status: FINISHED, Attempt: 2/30
[IG Publish] Response: {"id":"18074392880598848"}
```

一時的な問題だった可能性が高い。

---

## 2. 投稿試行ログ機能の実装

### 要件
- 一時的な問題を分析できるようにしたい
- 投稿制限（24時間/25件）の状況も把握したい
- ライセンス画面から呼び出せるUIがほしい

### 2.1 データベース設計

**テーブル: post_attempts**
```sql
CREATE TABLE post_attempts (
    id SERIAL PRIMARY KEY,
    license_id INTEGER REFERENCES licenses(id) ON DELETE SET NULL,
    facebook_page_id VARCHAR(255) NOT NULL,
    image_url TEXT,
    wordpress_post_id VARCHAR(255),
    status VARCHAR(20) NOT NULL,  -- success, failed, rate_limited, token_expired, container_error, publish_error
    error_code VARCHAR(50),
    error_message TEXT,
    quota_usage INTEGER,          -- 投稿時の使用数
    quota_total INTEGER DEFAULT 25,
    container_id VARCHAR(255),
    media_id VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 2.2 バックエンド実装

**ファイル構成**

| ファイル | 内容 |
|---------|------|
| `src/models/PostAttempt.js` | 投稿試行ログモデル（新規） |
| `src/controllers/postController.js` | 試行ログ記録処理を追加 |
| `src/controllers/licenseController.js` | 試行ログ取得API追加 |
| `src/routes/license.js` | エンドポイント追加 |

**PostAttemptモデル主要メソッド**
```javascript
// ステータス定数
static STATUS = {
  SUCCESS: 'success',
  FAILED: 'failed',
  RATE_LIMITED: 'rate_limited',
  TOKEN_EXPIRED: 'token_expired',
  CONTAINER_ERROR: 'container_error',
  PUBLISH_ERROR: 'publish_error',
};

// 主要メソッド
static async create(data)                    // 試行ログ記録
static async findByLicenseId(licenseId)      // ライセンス別履歴
static async getStats(licenseId, hours)      // 統計取得
static async getRecentErrors(hours)          // エラー傾向分析
static async getQuotaWarnings(thresholdPercent) // 制限警告
```

**新規APIエンドポイント**
```
GET /api/license/attempts/:licenseId        # 試行ログ取得
GET /api/license/attempts-stats/:licenseId  # 統計取得
GET /api/license/error-trends               # エラー傾向（全体）
```

**postControllerの変更**

投稿処理の各ステップで試行ログを記録：

1. **トークン期限切れ時**
   ```javascript
   await PostAttempt.create({
     status: PostAttempt.STATUS.TOKEN_EXPIRED,
     error_code: 'TOKEN_EXPIRED',
     ...
   });
   ```

2. **レート制限超過時**
   ```javascript
   await PostAttempt.create({
     status: PostAttempt.STATUS.RATE_LIMITED,
     quota_usage: limit.quotaUsage,
     ...
   });
   ```

3. **投稿成功時**
   ```javascript
   await PostAttempt.create({
     status: PostAttempt.STATUS.SUCCESS,
     quota_usage: limit.quotaUsage + 1,
     media_id: mediaId,
     ...
   });
   ```

4. **投稿失敗時**
   ```javascript
   await PostAttempt.create({
     status: status,  // CONTAINER_ERROR or PUBLISH_ERROR
     error_code: errorCode,
     error_message: error.message,
     ...
   });
   ```

### 2.3 フロントエンド実装

**ライセンス一覧画面（license.html）に追加**

1. **投稿ログボタン**: 各ライセンス行に「投稿ログ」ボタンを追加
2. **モーダルウィンドウ**: 統計と履歴を表示

**モーダル構成**

```
┌─────────────────────────────────────────────────┐
│ 投稿ログ - [ユーザー名]                    [×] │
├─────────────────────────────────────────────────┤
│ ┌─────┬─────┬─────┬─────┬──────┬───────┐       │
│ │合計 │成功 │失敗 │制限 │成功率│使用数 │       │
│ │ 10  │  8  │  1  │  1  │ 80%  │ 9/25  │       │
│ └─────┴─────┴─────┴─────┴──────┴───────┘       │
├─────────────────────────────────────────────────┤
│ [投稿履歴] [エラー傾向]                         │
├─────────────────────────────────────────────────┤
│ 日時        │ステータス│使用数  │エラー         │
│ 12/20 21:32 │成功      │9/25 ██ │-              │
│ 12/20 21:30 │失敗      │8/25 █  │PUBLISH_ERROR  │
│ ...                                             │
└─────────────────────────────────────────────────┘
```

**使用数バー表示**
- 緑（0-49%）: 余裕あり
- 黄（50-79%）: 注意
- 赤（80-100%）: 制限間近

---

## 3. 変更ファイル一覧

| ファイル | 変更種別 | 内容 |
|---------|---------|------|
| `db/schema.sql` | 修正 | post_attemptsテーブル追加 |
| `db/migrations/002_add_post_attempts_table.sql` | 新規 | マイグレーションスクリプト |
| `src/models/PostAttempt.js` | 新規 | 投稿試行ログモデル |
| `src/models/License.js` | 修正 | getAll()にlicense_id追加 |
| `src/controllers/postController.js` | 修正 | 試行ログ記録、投稿制限ログ追加 |
| `src/controllers/licenseController.js` | 修正 | 試行ログ取得API追加 |
| `src/routes/license.js` | 修正 | エンドポイント追加 |
| `src/services/instagramPostService.js` | 修正 | デバッグログ追加 |
| `public/license.html` | 修正 | 投稿ログモーダル追加 |

---

## 4. デプロイ手順

### Step 1: コードのデプロイ
```bash
git pull origin main
```

### Step 2: DBマイグレーション実行
```bash
psql -U postgres -d instagram_oauth -f db/migrations/002_add_post_attempts_table.sql
```

または直接実行:
```sql
CREATE TABLE IF NOT EXISTS post_attempts (
    id SERIAL PRIMARY KEY,
    license_id INTEGER REFERENCES licenses(id) ON DELETE SET NULL,
    facebook_page_id VARCHAR(255) NOT NULL,
    image_url TEXT,
    wordpress_post_id VARCHAR(255),
    status VARCHAR(20) NOT NULL,
    error_code VARCHAR(50),
    error_message TEXT,
    quota_usage INTEGER,
    quota_total INTEGER DEFAULT 25,
    container_id VARCHAR(255),
    media_id VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_post_attempts_license_id ON post_attempts(license_id);
CREATE INDEX IF NOT EXISTS idx_post_attempts_status ON post_attempts(status);
CREATE INDEX IF NOT EXISTS idx_post_attempts_created_at ON post_attempts(created_at);
```

### Step 3: アプリケーション再起動
```bash
pm2 restart in-gateway-api
```

### Step 4: 動作確認
- ライセンス管理画面で「投稿ログ」ボタンが表示されることを確認
- 投稿を実行し、ログが記録されることを確認

---

## 5. 分析クエリ例

### 直近24時間のエラー傾向
```sql
SELECT error_code, COUNT(*) as count
FROM post_attempts
WHERE status != 'success'
  AND created_at > NOW() - INTERVAL '24 hours'
GROUP BY error_code
ORDER BY count DESC;
```

### ライセンス別の成功率
```sql
SELECT
  license_id,
  COUNT(*) as total,
  SUM(CASE WHEN status = 'success' THEN 1 ELSE 0 END) as success,
  ROUND(SUM(CASE WHEN status = 'success' THEN 1 ELSE 0 END)::numeric / COUNT(*) * 100) as success_rate
FROM post_attempts
WHERE created_at > NOW() - INTERVAL '7 days'
GROUP BY license_id
ORDER BY total DESC;
```

### 投稿制限に近いライセンス
```sql
SELECT DISTINCT ON (license_id)
  license_id,
  quota_usage,
  quota_total,
  created_at
FROM post_attempts
WHERE quota_usage >= 20
  AND created_at > NOW() - INTERVAL '24 hours'
ORDER BY license_id, created_at DESC;
```

---

## 6. ログ出力例

### 投稿成功時
```
[IG Quota] Usage: 8/25, Remaining: 17
[IG Container Create] Response: {"id":"17853829353597900"}
[IG Container] ID: 17853829353597900, Status: IN_PROGRESS, Attempt: 1/30
[IG Container] ID: 17853829353597900, Status: FINISHED, Attempt: 2/30
[IG Publish] Response: {"id":"18074392880598848"}
```

### 投稿失敗時（コンテナエラー）
```
[IG Quota] Usage: 8/25, Remaining: 17
[IG Container Create] Response: {"id":"17853829353597900"}
[IG Container] ID: 17853829353597900, Status: undefined, Attempt: 1/30
Instagram post error: Error: Instagram投稿に失敗しました: メディアコンテナのステータスが無効です: undefined
```

### レート制限時
```
[IG Quota] Usage: 25/25, Remaining: 0
```
（429 Rate Limit Exceededを返却）

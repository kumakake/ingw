# WORK_LOG 2025-12-17

## 実装完了: Instagram投稿機能のバックエンド移行

### 背景・目的

**セキュリティ問題の発見**:
現在のアーキテクチャでは、WordPress側にaccess_tokenが渡されるため、PHPに慣れたユーザーがトークンをキャッシュしてライセンス/サブスク制限を回避できる問題があった。

**解決策**:
投稿処理をバックエンドに移行し、access_tokenをWordPress側に渡さない構成に変更。

### 新アーキテクチャ

```
WordPress ──①投稿リクエスト──▶ バックエンド ──②投稿実行──▶ Instagram
    │         (画像URL+キャプション)     │
    │                                    │
    │◀──────── 結果のみ返却 ─────────────┘
    │
    ※access_tokenはバックエンド内で完結
    ※WordPress側には一切渡さない
```

### 作成したファイル

| ファイル | 説明 |
|---------|------|
| `src/services/instagramPostService.js` | Instagram Graph API投稿サービス |
| `src/models/PostHistory.js` | 投稿履歴モデル |
| `src/controllers/postController.js` | 投稿APIコントローラー |
| `src/routes/post.js` | 投稿ルート定義 |

### 修正したファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/app.js` | postRoutesのインポートとルート登録 |
| `src/routes/api.js` | ミドルウェアのexport追加 |
| `db/schema.sql` | `post_history`テーブル追加 |

### 新規APIエンドポイント

| エンドポイント | 用途 | 認証 |
|--------------|------|------|
| `POST /api/post/instagram` | Instagram投稿 | ライセンス + サブスク |
| `GET /api/post/history` | 投稿履歴取得 | ライセンス + サブスク |
| `GET /api/post/limit/:facebookPageId` | 投稿制限確認 | ライセンス + サブスク |

### 投稿APIリクエスト例

```bash
curl -X POST http://localhost:3000/api/post/instagram \
  -H "Content-Type: application/json" \
  -H "X-License-Key: YOUR_LICENSE_KEY" \
  -d '{
    "facebookPageId": "123456789",
    "imageUrl": "https://example.com/image.jpg",
    "caption": "投稿テキスト #hashtag",
    "wordpressPostId": "42"
  }'
```

### 次のステップ

- [x] WordPressプラグイン側の修正（直接Graph API → バックエンドAPI経由に変更）
- [ ] 実際のInstagramアカウントで投稿テスト

---

## WordPressプラグイン修正完了

### 修正したファイル

| ファイル | 変更内容 |
|---------|---------|
| `includes/class-in-gateway-api.php` | `post_to_instagram()` をバックエンドAPI呼び出しに変更 |
| `includes/class-in-gateway.php` | WordPress投稿IDの送信追加、permalink保存追加 |

### 変更詳細

#### class-in-gateway-api.php

**変更前（セキュリティリスクあり）**:
```php
public function post_to_instagram($image_url, $caption) {
    // 1. バックエンドからaccess_token取得 ← 危険
    $credentials = $this->get_instagram_credentials();
    // 2. 直接Graph API呼び出し
    $this->create_media_container(...);
    $this->wait_for_container_ready(...);
    $this->publish_media(...);
}
```

**変更後（セキュア）**:
```php
public function post_to_instagram($image_url, $caption, $wordpress_post_id = null) {
    // バックエンドAPI経由で投稿
    $endpoint = sprintf('%s/api/post/instagram', $this->api_url);
    $response = wp_remote_post($endpoint, array(
        'headers' => array('X-License-Key' => $this->license_key),
        'body' => json_encode(array(
            'facebookPageId' => $this->facebook_page_id,
            'imageUrl' => $image_url,
            'caption' => $caption,
            'wordpressPostId' => $wordpress_post_id,
        )),
    ));
    // access_tokenはバックエンド内で完結
}
```

#### class-in-gateway.php

- WordPress投稿IDをAPIに送信するように変更
- 返却されるpermalinkをpost_metaに保存

### 非推奨メソッド

以下のメソッドは非推奨（@deprecated）としてマーク:
- `get_instagram_credentials()` - access_tokenを直接取得（セキュリティリスク）
- `create_media_container()` - Graph API直接呼び出し
- `wait_for_container_ready()` - Graph API直接呼び出し
- `publish_media()` - Graph API直接呼び出し

---

## 検討事項（保留）

Instagram投稿内容のAI加工機能の追加を検討。
→ 基本投稿機能の実装完了後に着手予定。詳細プランは `books/plan-gemini.md` を参照。

---

## 現在のアーキテクチャ（2025-12-17 更新）

### システム全体像（セキュア版）

```
┌─────────────────────────────────────────────────────────────────┐
│                        WordPress                                 │
│  ┌─────────────────┐    ┌─────────────────┐                     │
│  │ 記事作成・編集   │    │ Instagram投稿   │                     │
│  │                 │    │ プラグイン      │                     │
│  └─────────────────┘    └────────┬────────┘                     │
│                                  │                               │
└──────────────────────────────────┼───────────────────────────────┘
                                   │
                    ① 投稿リクエスト
                    │  POST /api/post/instagram
                    │  (X-License-Key ヘッダー + 画像URL + キャプション)
                    ▼
┌─────────────────────────────────────────────────────────────────┐
│              このバックエンド (oauth サービス)                    │
│  ┌─────────────────────────────────────────────┐                │
│  │ validateLicenseAndSubscription              │                │
│  │  - ライセンス確認                            │                │
│  │  - サブスクリプション(支払い)確認            │                │
│  └─────────────────────────────────────────────┘                │
│                         │                                        │
│                         ▼                                        │
│  ┌─────────────────────────────────────────────┐                │
│  │ instagramPostService.publishPhoto()         │  ② 投稿実行    │
│  │  - access_tokenを内部で取得                  │                │
│  │  - Instagram Graph API に投稿               │                │
│  │  ※ access_tokenはバックエンド内で完結        │                │
│  └─────────────────────────────────────────────┘                │
│                         │                                        │
│                         ▼                                        │
│                Instagram Graph API                               │
│                         │                                        │
│                         ▼                                        │
│  ┌─────────────────────────────────────────────┐                │
│  │ PostHistory.create()                        │                │
│  │  - 投稿履歴をDBに保存                        │                │
│  └─────────────────────────────────────────────┘                │
└─────────────────────────────────────────────────────────────────┘
                                   │
                    ③ 結果のみ返却
                    │  (media_id, permalink)
                    │  ※ access_tokenは返さない
                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                        WordPress                                 │
│  ┌─────────────────────────────────────────────┐                │
│  │ 投稿メタデータを保存                         │                │
│  │  - _in_gateway_media_id                     │                │
│  │  - _in_gateway_permalink                    │                │
│  └─────────────────────────────────────────────┘                │
└─────────────────────────────────────────────────────────────────┘
```

### 役割分担（更新後）

| コンポーネント | 役割 |
|--------------|------|
| **WordPress プラグイン** | 記事作成、投稿リクエスト送信、結果表示 |
| **oauth バックエンド** | OAuth認証、トークン管理、ライセンス/支払い確認、**Instagram投稿実行** |
| **Instagram Graph API** | 実際の投稿処理（バックエンドから呼び出し） |

---

## 支払い確認の仕組み

### ミドルウェアによる保護 (`src/routes/api.js:7-61`)

```javascript
const validateLicenseAndSubscription = async (req, res, next) => {
  const licenseKey = req.headers['x-license-key'];

  // Step 1: ライセンスキーの存在確認
  if (!licenseKey) {
    return res.status(401).json({
      error: 'ライセンスキーが必要です',
      licenseRequired: true
    });
  }

  // Step 2: ライセンスの有効性確認
  const license = await License.findByKey(licenseKey);
  if (!license || !license.is_active) {
    return res.status(401/403).json({ ... });
  }

  // Step 3: サブスクリプション確認 ← ここが支払いチェック
  if (license.user_id) {
    const hasSubscription = await User.hasActiveSubscription(license.user_id);
    if (!hasSubscription) {
      return res.status(403).json({
        error: '有効なサブスクリプションが必要です',
        subscriptionRequired: true  // ← WordPressはこれを見て判断
      });
    }
  }
};
```

### サブスクリプション確認ロジック (`src/models/User.js:126-150`)

```javascript
static async hasActiveSubscription(userId) {
  // DBから subscription_status, subscription_current_period_end, trial_end を取得

  // トライアル中？
  if (subscription_status === 'trialing' && trial_end > now) return true;

  // アクティブな支払い済み？
  if (subscription_status === 'active' && subscription_current_period_end > now) return true;

  return false;  // 支払いなし → 投稿不可
}
```

### 保護されているエンドポイント

| エンドポイント | 用途 | 認証 |
|--------------|------|------|
| `POST /api/post/instagram` | **Instagram投稿** | ライセンス + サブスク |
| `GET /api/post/history` | **投稿履歴取得** | ライセンス + サブスク |
| `GET /api/post/limit/:facebookPageId` | **投稿制限確認** | ライセンス + サブスク |
| `GET /api/instagram/user/:facebookUserId` | Instagram情報取得 | ライセンス + サブスク |
| `GET /api/instagram/page/:facebookPageId` | ページからInstagram情報取得 | ライセンス + サブスク |
| `GET /api/instagram/users` | 全アカウント一覧 | ライセンス + サブスク |
| `GET /api/instagram/test-connection/:facebookPageId` | 接続テスト | ライセンスのみ |

---

## プロジェクト構造

```
src/
├── app.js                              # メインアプリケーション
├── config/
│   ├── database.js                     # PostgreSQL接続設定
│   └── logger.js                       # Pino ロガー設定
├── middleware/
│   ├── adminAuth.js                    # 管理者認証ミドルウェア
│   └── jwtAuth.js                      # JWT認証ミドルウェア
├── models/
│   ├── InstagramUser.js                # Instagram連携ユーザーモデル
│   ├── License.js                      # ライセンスモデル
│   ├── User.js                         # ユーザーモデル
│   ├── PostHistory.js                  # 【新規】投稿履歴モデル
│   ├── EmailVerification.js            # メール検証トークン
│   └── PasswordReset.js                # パスワードリセットトークン
├── controllers/
│   ├── apiController.js                # API処理 (Instagram情報取得/トークン管理)
│   ├── authController.js               # OAuth認証処理
│   ├── licenseController.js            # ライセンス管理処理
│   ├── paymentController.js            # Stripe決済処理
│   ├── postController.js               # 【新規】Instagram投稿処理
│   ├── userController.js               # ユーザー管理処理
│   └── userLicenseController.js        # ユーザー向けライセンス処理
├── routes/
│   ├── api.js                          # /api/instagram (Instagram API)
│   ├── auth.js                         # /auth (OAuth認証)
│   ├── license.js                      # /api/license (ライセンス管理)
│   ├── payment.js                      # /api/payment (Stripe決済)
│   ├── post.js                         # 【新規】/api/post (Instagram投稿)
│   └── user.js                         # /api/user (ユーザー管理)
├── services/
│   ├── instagramService.js             # Facebook Graph API連携（認証）
│   ├── instagramPostService.js         # 【新規】Instagram投稿サービス
│   ├── emailService.js                 # メール送信処理
│   ├── stripeService.js                # Stripe API連携
│   └── tokenScheduler.js               # トークン自動更新スケジューラー
└── db/
    ├── schema.sql                      # データベーススキーマ
    └── migrations/                     # マイグレーションファイル
```

---

## 主要な機能

### 認証・ユーザー管理
- ユーザー登録/ログイン
- メール検証
- パスワードリセット
- JWT トークン管理

### Instagram連携
- Facebook OAuth 2.0フロー
- トークン取得・更新（60日有効の長期トークン）
- 複数アカウント管理
- トークン有効期限管理

### ライセンス・料金管理
- ライセンスキー発行/検証
- Stripe サブスクリプション連携
- ドメイン紐付け

---

## データベーステーブル

1. `instagram_users` - 認証済みInstagramアカウント
2. `users` - ユーザーアカウント
3. `licenses` - ライセンスキー
4. `post_history` - 【新規】Instagram投稿履歴
5. `email_verifications` - メール検証トークン
6. `password_resets` - パスワードリセットトークン

---

## 関連ファイル

- **WordPressプラグイン**: `/Users/kumakake/docker/kumakake/instagram/wordpress/wp-content/plugins/in-gateway`
- **AI投稿機能プラン**: `books/plan-gemini.md`

---

## 動作確認

### Docker 起動確認（2025-12-17）

```
instagram_oauth_app  | [2025-12-17 06:46:09] INFO: InstaBridge started
instagram_oauth_app  |     port: "3000"
instagram_oauth_app  |     env: "development"
instagram_oauth_app  |     redirectUri: "https://aca0feba6694.ngrok-free.app/auth/callback"
instagram_oauth_app  | [2025-12-17 06:46:09] INFO: Token scheduler started
instagram_oauth_app  |     intervalHours: 24
instagram_oauth_app  | [2025-12-17 06:46:09] INFO: No expiring tokens found
```

- バックエンド正常起動 ✅
- トークンスケジューラー稼働 ✅
- 期限切れトークンなし ✅

### 残タスク

- [ ] 実際のInstagramアカウントで投稿テスト

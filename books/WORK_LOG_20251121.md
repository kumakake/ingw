# 作業ログ - 2025年11月21日

## プロジェクト概要

**プロジェクト名**: Instagram OAuth Service
**目的**: WordPress連携用のInstagram Business Account IG_USER_ID取得サービス
**作業日**: 2025年11月21日
**作業時間**: 約2時間

## 要件定義

### ビジネス要件
- WordPressの記事をInstagramに自動投稿するシステムの基盤構築
- Instagram Business AccountのIG_USER_IDを取得
- 複数ユーザー・複数アカウント対応
- WordPress以外の外部サービスからも利用可能

### 技術要件
- **バックエンド**: Ubuntu + Node.js + Express + PostgreSQL
- **認証**: Facebook OAuth 2.0
- **API**: Facebook Graph API v18.0
- **開発環境**: Docker Compose
- **フロントエンド**: シンプルなHTML（認証UI）

### 主要機能
1. Facebook OAuthによるInstagram Business Account認証
2. 長期アクセストークン（60日間有効）の取得と管理
3. IG_USER_ID、FBページID、アクセストークンの保存
4. 外部API（WordPress等）への情報提供

## 実装内容

### 1. プロジェクト構造設計

```
instagram-oauth/
├── src/
│   ├── app.js                      # Expressアプリケーション
│   ├── config/
│   │   └── database.js            # PostgreSQL接続設定
│   ├── models/
│   │   └── InstagramUser.js       # データベースモデル
│   ├── services/
│   │   └── instagramService.js    # Instagram OAuth ロジック
│   ├── controllers/
│   │   ├── authController.js      # 認証コントローラー
│   │   └── apiController.js       # API コントローラー
│   └── routes/
│       ├── auth.js                # 認証ルート
│       └── api.js                 # API ルート
├── public/
│   └── index.html                 # フロントエンド UI
├── db/
│   └── schema.sql                 # データベーススキーマ
├── scripts/
│   ├── start.sh                   # アプリ起動スクリプト
│   └── wait-for-db.sh            # DB待機スクリプト
├── Dockerfile                      # Node.js イメージ定義
├── docker-compose.yml              # サービス定義
├── Makefile                        # 開発用コマンド集
├── .env.example                    # ローカル環境用テンプレート
├── .env.docker                     # Docker環境用テンプレート
├── .gitignore
├── .dockerignore
├── package.json
├── README.md                       # プロジェクトガイド
├── CLAUDE.md                       # Claude Code用ガイド
└── DOCKER.md                       # Docker詳細ガイド
```

### 2. データベース設計

#### テーブル: instagram_users

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | SERIAL PRIMARY KEY | 主キー |
| facebook_user_id | VARCHAR(255) UNIQUE | Facebookユーザー識別子 |
| access_token | TEXT | 長期アクセストークン |
| token_expires_at | TIMESTAMP | トークン有効期限 |
| facebook_page_id | VARCHAR(255) | FBページID |
| facebook_page_name | VARCHAR(255) | FBページ名 |
| instagram_user_id | VARCHAR(255) | IG_USER_ID（主要データ） |
| instagram_username | VARCHAR(255) | Instagramユーザー名 |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

**インデックス**:
- `facebook_user_id`
- `instagram_user_id`
- `facebook_page_id`

**トリガー**: `updated_at` 自動更新

### 3. OAuth フロー実装

```
1. ユーザーがログインボタンをクリック
   ↓
2. Facebook OAuth 認証ページにリダイレクト
   ↓
3. ユーザーが権限を許可
   ↓
4. コールバックで認証コードを受信
   ↓
5. 認証コードを短期アクセストークンに交換
   ↓
6. 短期トークンを長期トークンに変換（60日有効）
   ↓
7. ユーザーのFacebookページ一覧を取得
   ↓
8. 各ページのInstagram Business Accountを取得
   ↓
9. IG_USER_IDとアクセストークンをDBに保存
   ↓
10. 取得結果をフロントエンドに表示
```

### 4. API エンドポイント

#### 認証系
- `GET /auth/login` - OAuth認証開始
- `GET /auth/callback` - OAuthコールバック処理
- `GET /auth/status` - 認証済みアカウント一覧

#### 外部API系（WordPress連携用）
- `GET /api/instagram/user/:facebookUserId` - Facebook User IDでIG_USER_ID取得
- `GET /api/instagram/page/:facebookPageId` - Facebook Page IDでIG_USER_ID取得
- `GET /api/instagram/users` - 全ユーザー一覧

#### ユーティリティ
- `GET /health` - ヘルスチェック

### 5. フロントエンド実装

**機能**:
- Instagram認証開始ボタン
- OAuth認証結果の表示
- エラーメッセージの表示
- 取得データのコピー機能

**技術**:
- バニラJavaScript
- レスポンシブデザイン
- URLパラメータでのデータ受け渡し

### 6. Docker環境構築

#### docker-compose.yml 構成

**サービス**:
1. **app** (Node.js アプリケーション)
   - イメージ: カスタム（Node.js 18 Alpine）
   - ポート: 3000
   - ボリューム: ソースコードホットリロード
   - 依存: db サービス

2. **db** (PostgreSQL)
   - イメージ: postgres:15-alpine
   - ポート: 5432
   - ボリューム: データ永続化
   - 自動スキーマ初期化

**特徴**:
- ヘルスチェック実装
- 自動再起動設定
- 環境変数による柔軟な設定
- 開発環境最適化（nodemon、ボリュームマウント）

#### Makefile コマンド

```bash
make up          # サービス起動
make down        # サービス停止
make logs        # ログ表示
make shell       # コンテナに入る
make db-shell    # PostgreSQL接続
make db-reset    # DB初期化
make clean       # 完全クリーンアップ
```

## 技術的な実装詳細

### Facebook Graph API 統合

**使用バージョン**: v18.0

**必要な権限**:
- `pages_show_list` - Facebookページ一覧取得
- `pages_read_engagement` - ページデータ読み取り
- `instagram_basic` - Instagram基本情報
- `instagram_content_publish` - 投稿機能（将来用）
- `pages_manage_metadata` - ページメタデータ管理

**主要エンドポイント**:
- `/oauth/access_token` - トークン交換・延長
- `/me/accounts` - ユーザーのページ取得
- `/{page_id}?fields=instagram_business_account` - Instagram Account取得
- `/{instagram_user_id}` - Instagram情報取得

### セキュリティ対策

1. **環境変数管理**: 機密情報は.envファイルで管理
2. **CORS設定**: 許可ドメインのホワイトリスト化
3. **トークン管理**: 有効期限チェックとエラーハンドリング
4. **SQL インジェクション対策**: パラメータ化クエリ使用

### エラーハンドリング

- サービス層で詳細なエラーをスロー
- コントローラー層でユーザーフレンドリーなメッセージに変換
- OAuth エラーはクエリパラメータでフロントエンドに通知
- 統一されたJSONレスポンス形式 `{success, data/error}`

## 作成ファイル一覧

### バックエンド（13ファイル）
1. `src/app.js` - Express アプリケーション設定
2. `src/config/database.js` - PostgreSQL接続プール
3. `src/models/InstagramUser.js` - データベースモデル（CRUD操作）
4. `src/services/instagramService.js` - Instagram OAuth ビジネスロジック
5. `src/controllers/authController.js` - 認証エンドポイント処理
6. `src/controllers/apiController.js` - API エンドポイント処理
7. `src/routes/auth.js` - 認証ルート定義
8. `src/routes/api.js` - API ルート定義

### フロントエンド（1ファイル）
9. `public/index.html` - 認証UI（HTML/CSS/JavaScript）

### データベース（1ファイル）
10. `db/schema.sql` - PostgreSQLスキーマ定義

### Docker関連（7ファイル）
11. `Dockerfile` - Node.js イメージ定義
12. `docker-compose.yml` - サービス定義
13. `.dockerignore` - ビルド除外設定
14. `.env.docker` - Docker環境用テンプレート
15. `Makefile` - 開発用コマンド集
16. `scripts/start.sh` - アプリ起動スクリプト
17. `scripts/wait-for-db.sh` - DB待機スクリプト

### 設定・ドキュメント（7ファイル）
18. `package.json` - Node.js依存関係
19. `.env.example` - ローカル環境用テンプレート
20. `.gitignore` - Git除外設定
21. `README.md` - プロジェクトガイド
22. `CLAUDE.md` - Claude Code用開発ガイド
23. `DOCKER.md` - Docker詳細ガイド
24. `books/WORK_LOG_20251121.md` - 本ファイル

**合計**: 24ファイル

## パッケージ依存関係

### 本番依存関係
- `express@^4.18.2` - Webフレームワーク
- `pg@^8.11.3` - PostgreSQL クライアント
- `axios@^1.6.2` - HTTP クライアント
- `dotenv@^16.3.1` - 環境変数管理
- `cors@^2.8.5` - CORS ミドルウェア

### 開発依存関係
- `nodemon@^3.0.2` - ホットリロード

## セットアップ手順

### Docker Compose を使う場合（推奨）

```bash
# 1. 環境変数設定
cp .env.docker .env
nano .env  # Meta App情報を設定

# 2. サービス起動
make up

# 3. アクセス
# http://localhost:3000
```

### ローカル環境の場合

```bash
# 1. 依存関係インストール
npm install

# 2. 環境変数設定
cp .env.example .env
nano .env

# 3. PostgreSQL起動とDB作成
psql -U postgres -c "CREATE DATABASE instagram_oauth;"
psql -U postgres -d instagram_oauth -f db/schema.sql

# 4. アプリ起動
npm run dev
```

## Meta App 設定

**Meta Developer Console** (https://developers.facebook.com/) で設定：

1. **アプリの作成**
   - タイプ: ビジネス
   - 製品: Facebook Login + Instagram Graph API

2. **有効なOAuthリダイレクトURI**
   ```
   http://localhost:3000/auth/callback
   https://your-domain.com/auth/callback
   ```

3. **権限リクエスト**
   - pages_show_list
   - pages_read_engagement
   - instagram_basic
   - instagram_content_publish
   - pages_manage_metadata

4. **アプリレビュー**（本番環境用）
   - 上記権限の承認申請

## 動作確認

### 1. サービス起動確認

```bash
# ヘルスチェック
curl http://localhost:3000/health

# 期待レスポンス
{"status":"ok","timestamp":"2025-11-21T01:16:00.000Z"}
```

### 2. OAuth フロー確認

1. http://localhost:3000 にアクセス
2. 「Instagram認証を開始」クリック
3. Facebookログイン
4. 権限許可
5. IG_USER_ID が表示されることを確認

### 3. API エンドポイント確認

```bash
# 全ユーザー取得
curl http://localhost:3000/api/instagram/users

# 特定ユーザー取得（要実際のID）
curl http://localhost:3000/api/instagram/page/{facebook_page_id}
```

## トラブルシューティング

### よくある問題と解決方法

#### 1. "No Instagram Business Accounts found"

**原因**: FacebookページとInstagram Business Accountが連携されていない

**解決方法**:
- Facebook Business Manager でページ設定を確認
- InstagramアカウントをBusiness Accountに変換
- FacebookページとInstagramアカウントをリンク

#### 2. データベース接続エラー

**原因**: PostgreSQLが起動していない、または接続情報が間違っている

**解決方法**:
```bash
# Docker の場合
make logs-db
docker-compose ps

# ローカルの場合
sudo systemctl status postgresql
```

#### 3. ポート競合

**原因**: ポート3000が既に使用されている

**解決方法**:
```bash
# .env でポート変更
PORT=3001
```

## WordPress連携パターン

### WordPress側の実装イメージ

```php
<?php
// Instagram IG_USER_ID 取得関数
function get_instagram_user_id($facebook_page_id) {
    $api_url = "http://your-oauth-service:3000/api/instagram/page/{$facebook_page_id}";

    $response = wp_remote_get($api_url);

    if (is_wp_error($response)) {
        return false;
    }

    $data = json_decode(wp_remote_retrieve_body($response), true);

    if ($data['success']) {
        // IG_USER_ID とアクセストークンを保存
        update_option('instagram_user_id', $data['data']['instagramUserId']);
        update_option('instagram_access_token', $data['data']['accessToken']);
        update_option('token_expires_at', $data['data']['tokenExpiresAt']);

        return $data['data']['instagramUserId'];
    }

    // トークン期限切れの場合は再認証を促す
    if (isset($data['tokenExpired']) && $data['tokenExpired']) {
        // 再認証フローへリダイレクト
    }

    return false;
}
?>
```

## 今後の拡張予定

### フェーズ2: Instagram投稿機能

**予定機能**:
- WordPressの記事データ受信API
- Instagram画像・動画投稿API
- 投稿スケジューリング
- 投稿履歴管理

**必要な実装**:
1. メディアアップロードエンドポイント
   - `POST /api/instagram/media`
   - 画像・動画のアップロード処理

2. 投稿公開エンドポイント
   - `POST /api/instagram/publish`
   - キャプション、ハッシュタグ対応

3. 投稿状態確認
   - `GET /api/instagram/media/:media_id`
   - 公開状態の確認

### フェーズ3: 高度な機能

- トークン自動更新機能
- Webhook対応（Instagram側のイベント受信）
- 投稿分析・インサイト取得
- 複数画像投稿（カルーセル）
- ストーリー投稿対応
- リール投稿対応

## 学んだこと・改善点

### 成功したポイント
1. **Docker Compose統合**: 開発環境のセットアップが大幅に簡易化
2. **サービス層分離**: ビジネスロジックとコントローラーの明確な分離
3. **エラーハンドリング**: 各層での適切なエラー処理
4. **ドキュメント充実**: README、CLAUDE.md、DOCKER.mdで異なる視点をカバー

### 改善の余地
1. **テストコード**: ユニットテスト・統合テストの追加
2. **ロギング**: より詳細なログ記録（winston等）
3. **バリデーション**: 入力値の厳密なバリデーション
4. **レート制限**: API呼び出しのレート制限実装
5. **監視**: Prometheus/Grafanaでのメトリクス収集

## メモ・注意事項

### Instagram Business Account 要件
- 個人アカウントではなく、Business Accountが必須
- Facebookページとのリンクが必須
- プロフィール情報が完全に設定されている必要あり

### トークン管理
- 長期トークンの有効期限: 60日間
- 有効期限切れ前の更新ロジックが必要（将来実装）
- トークンは暗号化して保存することを推奨（現在は平文）

### API制限
- Facebook Graph API のレート制限に注意
- 1時間あたり200リクエストが標準
- ビジネス検証で上限引き上げ可能

### セキュリティ
- 本番環境では HTTPS 必須
- 環境変数の厳重な管理
- CORS設定の適切な制限
- アクセストークンの暗号化検討

## 参考資料

### 公式ドキュメント
- [Instagram Graph API](https://developers.facebook.com/docs/instagram-api)
- [Facebook Login](https://developers.facebook.com/docs/facebook-login)
- [Long-Lived Access Tokens](https://developers.facebook.com/docs/facebook-login/guides/access-tokens/get-long-lived)

### 技術スタック
- [Express.js](https://expressjs.com/)
- [node-postgres](https://node-postgres.com/)
- [Docker Compose](https://docs.docker.com/compose/)

## 完了チェックリスト

- [x] プロジェクト構造設計
- [x] データベーススキーマ設計
- [x] PostgreSQL接続実装
- [x] Instagram OAuth フロー実装
- [x] データベースモデル実装
- [x] API エンドポイント実装
- [x] フロントエンドUI実装
- [x] Dockerfile作成
- [x] docker-compose.yml作成
- [x] Makefile作成
- [x] 環境変数設定ファイル作成
- [x] README.md作成
- [x] CLAUDE.md作成
- [x] DOCKER.md作成
- [x] 動作確認
- [x] 作業ログ作成

## 作業時間内訳

- 要件定義・設計: 15分
- バックエンド実装: 45分
- フロントエンド実装: 15分
- Docker環境構築: 30分
- ドキュメント作成: 15分

**合計**: 約2時間

## まとめ

WordPress連携用のInstagram OAuth サービスをゼロから構築しました。Docker Composeによる開発環境も整備し、すぐに開発を開始できる状態になっています。

主要な成果物：
- 完全に動作するOAuthフロー
- 複数アカウント対応のデータベース設計
- 外部API提供機能
- Docker Compose による再現可能な開発環境
- 充実したドキュメント

次のフェーズでInstagram投稿機能を実装することで、WordPressからの自動投稿が実現できます。

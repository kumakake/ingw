# 作業ログ 2025/11/23

## 概要

Instagram OAuth APIサービスとWordPressプラグイン「IN-Gateway」の開発・設定作業

## 実施内容

### 1. ライセンス管理機能の拡張

#### 1.1 未使用ライセンス削除機能の追加

**APIエンドポイント追加:**
- `DELETE /api/license/delete` - 未使用ライセンスの削除

**ファイル変更:**
- `src/routes/license.js` - 削除ルート追加
- `src/controllers/licenseController.js` - deleteメソッド追加
- `src/models/License.js` - deleteUnusedメソッド追加
- `public/license.html` - 削除ボタンとdeleteLicense関数追加

**仕様:**
- ドメイン未登録（未使用）のライセンスのみ削除可能
- 使用中のライセンスは削除不可（エラーメッセージ表示）
- 確認ダイアログ付き

---

### 2. WordPressプラグイン「IN-Gateway」

#### 2.1 プラグイン機能

- WordPress投稿公開時にInstagramへ自動連携
- アイキャッチ画像を使用
- 本文は2,000文字制限（Instagram仕様）
- 改行を保持
- ライセンスキーによる利用制限

#### 2.2 ファイル構成

```
plugins/in-gateway/
├── in-gateway.php              # メインプラグインファイル
├── uninstall.php               # アンインストール処理
└── includes/
    ├── class-in-gateway.php        # メインクラス（投稿フック）
    ├── class-in-gateway-api.php    # Instagram API連携
    └── class-in-gateway-admin.php  # 管理画面設定
```

#### 2.3 設定項目

| 項目 | 説明 |
|------|------|
| ライセンスキー | 32文字英数字大文字 |
| Facebook Page ID | Instagram Business Accountに紐づくPage ID |

#### 2.4 OAuth API URL

```php
define('IN_GATEWAY_OAUTH_API_URL', 'https://ingw.ai-trans-labo.fun');
```

---

### 3. 本番環境設定

#### 3.1 Meta Developer Console設定

**有効なOAuthリダイレクトURI:**
```
https://ingw.ai-trans-labo.fun/auth/callback
```

#### 3.2 PM2設定ファイル

`ecosystem.config.js` を作成:

```javascript
module.exports = {
  apps: [
    {
      name: 'in-gateway-api',
      script: 'src/app.js',
      instances: 1,
      autorestart: true,
      watch: false,
      max_memory_restart: '256M',
      env_production: {
        NODE_ENV: 'production',
        PORT: 3000,
        DB_HOST: 'localhost',
        DB_PORT: 5432,
        DB_NAME: 'instagram_oauth',
        DB_USER: 'postgres',
        DB_PASSWORD: 'your_database_password',
        FACEBOOK_APP_ID: 'your_facebook_app_id',
        FACEBOOK_APP_SECRET: 'your_facebook_app_secret',
        REDIRECT_URI: 'https://ingw.ai-trans-labo.fun/auth/callback',
        ALLOWED_ORIGINS: 'https://ingw.ai-trans-labo.fun',
        SESSION_SECRET: 'your_session_secret',
      },
      error_file: './logs/error.log',
      out_file: './logs/out.log',
      log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
      merge_logs: true,
    },
  ],
};
```

**PM2コマンド:**
```bash
# ログディレクトリ作成
mkdir -p logs

# 起動
pm2 start ecosystem.config.js --env production

# ステータス確認
pm2 status

# ログ確認
pm2 logs in-gateway-api

# 再起動
pm2 restart in-gateway-api

# 自動起動設定
pm2 startup
pm2 save
```

---

### 4. データベース情報

#### 4.1 登録済みInstagramアカウント

| Facebook Page ID | Instagram User ID |
|------------------|-------------------|
| 899089366611951 | 17841477936988563 |

#### 4.2 ライセンステーブル構造

```sql
CREATE TABLE licenses (
    id SERIAL PRIMARY KEY,
    license_key VARCHAR(32) UNIQUE NOT NULL,
    user_no VARCHAR(50),
    user_name VARCHAR(255),
    domain VARCHAR(255),
    is_active BOOLEAN DEFAULT true,
    activated_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

### 5. API エンドポイント一覧

#### 5.1 認証関連 (`/auth`)

| メソッド | パス | 説明 |
|----------|------|------|
| GET | /auth/login | OAuth認証開始 |
| GET | /auth/callback | OAuthコールバック |
| GET | /auth/status | 認証状態確認 |

#### 5.2 Instagram API (`/api/instagram`)

| メソッド | パス | 説明 |
|----------|------|------|
| GET | /api/instagram/user/:facebookUserId | Facebook User IDで検索 |
| GET | /api/instagram/page/:facebookPageId | Facebook Page IDで検索 |
| GET | /api/instagram/users | 全アカウント一覧 |
| GET | /api/instagram/tokens/status | トークン状態確認 |
| POST | /api/instagram/tokens/refresh/:facebookPageId | トークン更新 |
| POST | /api/instagram/tokens/refresh-all | 全トークン更新 |

#### 5.3 ライセンス API (`/api/license`)

| メソッド | パス | 説明 |
|----------|------|------|
| POST | /api/license/validate | ライセンス検証 |
| POST | /api/license/generate | ライセンス発行 |
| GET | /api/license/list | ライセンス一覧 |
| POST | /api/license/update | 利用者情報更新 |
| POST | /api/license/deactivate | ライセンス無効化 |
| POST | /api/license/reset | ドメインリセット |
| DELETE | /api/license/delete | ライセンス削除（未使用のみ） |

---

### 6. 管理画面URL

| 画面 | URL |
|------|-----|
| OAuth認証画面 | https://ingw.ai-trans-labo.fun/ |
| ライセンス管理 | https://ingw.ai-trans-labo.fun/license.html |

---

### 7. トラブルシューティング

#### 7.1 Instagram投稿エラー

**エラー:** `Only photo or video can be accepted as media type.`

**原因:** Instagram APIが画像URLにアクセスできない（localhost等）

**解決:**
- 本番環境（外部からアクセス可能なURL）でテスト
- 画像形式はJPEG推奨

#### 7.2 ライセンス検証エラー

**確認事項:**
- ライセンスキーが32文字英数字大文字か
- ライセンスが有効（is_active = true）か
- 別ドメインで使用されていないか

---

### 8. 次のステップ

1. 本番サーバーにデプロイ
2. Meta Developer ConsoleでリダイレクトURI設定
3. 本番WordPressにプラグインをインストール
4. ライセンス発行・設定
5. テスト投稿で動作確認

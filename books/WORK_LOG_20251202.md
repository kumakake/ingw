# 作業ログ 2025-12-02

## 概要
Stripe決済機能のキャンセル処理テストと、プラン変更機能の実装

---

## 1. キャンセル処理の動作確認

### 1.1 テスト環境準備
- ngrok Webhook URL設定済み
- テストユーザー: `testuser01` (id: 1)
- Stripe顧客ID: `cus_TLmZHGkzC8TzNc`

### 1.2 テスト実施項目

| テスト項目 | 結果 | 備考 |
|-----------|------|------|
| サブスクリプション登録 | ✅ 成功 | 月額プラン、トライアル開始 |
| キャンセル（期間終了時） | ✅ 成功 | `cancel_at_period_end: true` |
| キャンセル取り消し（再開） | ✅ 成功 | Stripeポータルから操作 |
| 即時キャンセル | ✅ 成功 | `subscription.deleted` イベント処理 |

### 1.3 発見・修正したバグ

#### バグ1: `cancel_at_period_end` がAPIレスポンスに含まれない

**原因**: `User.findById()` のSELECT文に `cancel_at_period_end` カラムが含まれていなかった

**修正ファイル**: `src/models/User.js`

```javascript
// Before
'SELECT id, login_account, stripe_customer_id, subscription_status, subscription_id, subscription_plan, subscription_current_period_end, trial_end, created_at, updated_at FROM users WHERE id = $1'

// After
'SELECT id, login_account, stripe_customer_id, subscription_status, subscription_id, subscription_plan, subscription_current_period_end, trial_end, cancel_at_period_end, created_at, updated_at FROM users WHERE id = $1'
```

#### バグ2: 解約予定時に「決済管理」セクションが非表示

**問題**: キャンセル予定の場合、Stripeポータルへのリンクが表示されず、キャンセルの取り消しができない

**修正ファイル**: `public/user/dashboard.html`

```javascript
// Before
if (!sub.cancelAtPeriodEnd) {
  document.getElementById('billingSection').style.display = 'block';
}

// After
document.getElementById('billingSection').style.display = 'block';
```

---

## 2. プラン変更機能の実装

### 2.1 要件
- 月額プラン ⇔ 年額プランの相互変更
- 日割り計算なし（次回更新時から新プラン料金適用）
- ダッシュボード内にプラン変更ボタンを配置

### 2.2 変更ファイル

#### 2.2.1 src/services/stripeService.js

`updateSubscriptionPlan()` メソッドを追加

```javascript
async updateSubscriptionPlan(userId, newPlan) {
  const user = await User.findById(userId);

  if (!user || !user.subscription_id) {
    throw new Error('No active subscription found');
  }

  const currentSubscription = await this.stripe.subscriptions.retrieve(user.subscription_id);

  const newPriceId = newPlan === 'yearly'
    ? this.priceIdYearly
    : this.priceIdMonthly;

  const subscription = await this.stripe.subscriptions.update(
    user.subscription_id,
    {
      items: [{
        id: currentSubscription.items.data[0].id,
        price: newPriceId
      }],
      proration_behavior: 'none'  // 日割り計算なし
    }
  );

  return subscription;
}
```

#### 2.2.2 src/controllers/paymentController.js

`changePlan` コントローラー関数を追加

```javascript
const changePlan = async (req, res) => {
  try {
    const { plan } = req.body;

    if (!['monthly', 'yearly'].includes(plan)) {
      return res.status(400).json({
        success: false,
        error: 'プランは monthly または yearly を指定してください'
      });
    }

    const status = await stripeService.getSubscriptionStatus(req.user.id);
    if (status.plan === plan) {
      return res.status(400).json({
        success: false,
        error: '既に同じプランです'
      });
    }

    const subscription = await stripeService.updateSubscriptionPlan(req.user.id, plan);

    res.json({
      success: true,
      message: 'プランを変更しました',
      subscription: {
        plan: plan,
        status: subscription.status
      }
    });
  } catch (error) {
    // エラーハンドリング
  }
};
```

`module.exports` に `changePlan` を追加

#### 2.2.3 src/routes/payment.js

新しいエンドポイントを追加

```javascript
router.post('/change-plan', authenticateToken, paymentController.changePlan);
```

#### 2.2.4 public/user/dashboard.html

**UIの追加**: サブスクリプション状態セクションにプラン変更ボタンを追加

```javascript
// プラン変更セクション（解約予定でない場合のみ）
let planChangeHtml = '';
if (!sub.cancelAtPeriodEnd) {
  const otherPlan = sub.plan === 'monthly' ? 'yearly' : 'monthly';
  const otherPlanName = otherPlan === 'yearly' ? '年額プラン' : '月額プラン';
  const otherPlanPrice = otherPlan === 'yearly' ? '¥10,000/年' : '¥1,000/月';

  planChangeHtml = `
    <div class="mt-4" style="border-top: 1px solid var(--border-color); padding-top: 16px;">
      <div class="stat-label">プラン変更</div>
      <p style="font-size: 14px; color: var(--text-light); margin-bottom: 12px;">
        ${otherPlanName}（${otherPlanPrice}）に変更できます。<br>
        次回更新時から新しい料金が適用されます。
      </p>
      <button class="btn btn-secondary" onclick="changePlan('${otherPlan}')">
        ${otherPlanName}に変更
      </button>
    </div>
  `;
}
```

**JavaScript関数の追加**:

```javascript
async function changePlan(newPlan) {
  const planName = newPlan === 'yearly' ? '年額プラン' : '月額プラン';

  if (!confirm(`${planName}に変更しますか？\n次回更新時から新しい料金が適用されます。`)) {
    return;
  }

  try {
    const { data } = await api.post('/api/payment/change-plan', { plan: newPlan });

    if (data.success) {
      showMessage('プランを変更しました', 'success');
      await loadSubscriptionStatus();
    } else {
      showMessage(data.error || 'プラン変更に失敗しました', 'error');
    }
  } catch (error) {
    showMessage('通信エラーが発生しました', 'error');
  }
}
```

### 2.3 Webhookの対応

既存の `customer.subscription.updated` イベントハンドラーがプラン変更を自動的に処理。
`handleSubscriptionUpdate()` で `subscription_plan` を更新。

### 2.4 動作確認結果

| テスト項目 | 結果 |
|-----------|------|
| 月額→年額プラン変更 | ✅ 成功 |
| 年額→月額プラン変更 | ✅ 成功 |
| Webhook処理 | ✅ 正常動作 |
| UI表示更新 | ✅ 正常動作 |

---

## 3. APIエンドポイント一覧（更新後）

| メソッド | エンドポイント | 機能 | 認証 |
|---------|---------------|------|------|
| POST | `/api/payment/create-checkout-session` | チェックアウトセッション作成 | JWT必須 |
| POST | `/api/payment/billing-portal` | 請求管理ポータル | JWT必須 |
| GET | `/api/payment/subscription-status` | サブスクリプション状態取得 | JWT必須 |
| POST | `/api/payment/cancel-subscription` | サブスクリプション解約 | JWT必須 |
| POST | `/api/payment/change-plan` | **プラン変更（新規）** | JWT必須 |
| POST | `/api/webhook/stripe` | Stripeウェブフック | 署名検証 |

---

## 4. UI状態遷移

| 状態 | バッジ | プラン変更ボタン | 決済管理ボタン |
|------|--------|-----------------|---------------|
| 未登録 | 黄「未登録」 | 非表示 | 非表示 |
| トライアル中 | 青「無料トライアル中」 | 表示 | 表示 |
| 有効 | 緑「有効」 | 表示 | 表示 |
| 解約予定 | 黄「解約予定」 | 非表示 | 表示 |
| 解約済み | 赤「解約済み」 | 非表示 | 非表示 |

---

## 5. 今後の課題

- [ ] プラン変更履歴の記録
- [ ] プラン変更時のメール通知
- [ ] 管理者向けサブスクリプション管理画面

---

## 6. 環境情報

- プロジェクト: oauth (Instagram OAuth Service)
- Node.js: 18.x (Alpine)
- PostgreSQL: 15 (Alpine)
- Stripe API: 最新版

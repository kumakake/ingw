# 作業ログ 2025-11-22

## 概要
Instagram OAuth サービスの初期セットアップ、OAuth認証フロー修正、トークン自動延長機能の実装

---

## 1. Docker環境のセットアップ

### 問題1: `npm ci` エラー
```
npm error The `npm ci` command can only install with an existing package-lock.json
```

### 解決策
```bash
npm install  # package-lock.json を生成
```

### 問題2: ポート5432競合
```
Bind for 0.0.0.0:5432 failed: port is already allocated
```

### 解決策
```bash
docker system prune -f --volumes  # 古いコンテナとボリュームをクリーンアップ (40GB解放)
make up  # 再起動
```

---

## 2. OAuth認証フローの修正

### 問題: Facebook ページが取得できない
```
API /me/accounts response: { "data": [] }
Error: No Facebook pages found.
```

### 原因
`business_management` スコープが不足していた

### 解決策
`src/services/instagramService.js` のスコープに追加:
```javascript
const scopes = [
  'pages_show_list',
  'pages_read_engagement',
  'instagram_basic',
  'instagram_content_publish',
  'pages_manage_metadata',
  'business_management',  // 追加
];
```

### 結果
```
Facebook Page: Ai-cat.fun (ID: 899089366611951)
Instagram User ID: 17841477936988563
Instagram Username: @aicatda
```

---

## 3. Access Token 表示機能追加

### 変更ファイル

#### `src/controllers/authController.js`
コールバックデータに `accessToken` を追加

#### `src/controllers/apiController.js`
全APIレスポンスに `accessToken` を追加

#### `public/index.html`
結果カードに Access Token 行を追加（Instagram User ID の上に表示）

---

## 4. トークン自動延長機能の実装

### 新規ファイル

#### `src/services/tokenScheduler.js`
- 24時間ごとに期限切れ間近のトークンをチェック
- 期限30日前になると自動で延長
- サーバー起動時に自動開始

### 変更ファイル

#### `src/models/InstagramUser.js`
新規メソッド追加:
- `findByPageId(facebookPageId)` - ページIDで検索
- `updateToken(facebookPageId, accessToken, tokenExpiresAt)` - トークン更新
- `getExpiringTokens(daysBeforeExpiry)` - 期限切れ間近のトークン取得
- `getExpiredTokens()` - 期限切れトークン取得

#### `src/services/instagramService.js`
新規メソッド追加:
- `refreshLongLivedToken(currentToken)` - Long-lived tokenを新しいtokenに交換

#### `src/controllers/apiController.js`
新規エンドポイント追加:
- `refreshToken` - 特定ページのトークンを手動延長
- `refreshAllTokens` - 全トークンを一括延長
- `getExpiringTokens` - 期限切れ間近/期限切れトークン一覧

#### `src/routes/api.js`
新規ルート追加:
```javascript
router.get('/tokens/status', apiController.getExpiringTokens);
router.post('/tokens/refresh/:facebookPageId', apiController.refreshToken);
router.post('/tokens/refresh-all', apiController.refreshAllTokens);
```

#### `src/app.js`
スケジューラー統合:
```javascript
const tokenScheduler = require('./services/tokenScheduler');

// サーバー起動時にスケジューラー開始
if (process.env.NODE_ENV !== 'test') {
  tokenScheduler.start();
}
```

---

## 5. API エンドポイント一覧

### 認証関連
| エンドポイント | メソッド | 説明 |
|---------------|---------|------|
| `/auth/login` | GET | OAuth認証開始 |
| `/auth/callback` | GET | OAuth コールバック |
| `/auth/status` | GET | 認証済みアカウント一覧 |

### Instagram API
| エンドポイント | メソッド | 説明 |
|---------------|---------|------|
| `/api/instagram/users` | GET | 全ユーザー一覧 |
| `/api/instagram/user/:facebookUserId` | GET | Facebook User IDで取得 |
| `/api/instagram/page/:facebookPageId` | GET | Facebook Page IDで取得 |

### トークン管理
| エンドポイント | メソッド | 説明 |
|---------------|---------|------|
| `/api/instagram/tokens/status` | GET | 期限切れ間近/期限切れトークン一覧 |
| `/api/instagram/tokens/refresh/:pageId` | POST | 特定ページのトークンを手動延長 |
| `/api/instagram/tokens/refresh-all` | POST | 全トークンを一括延長 |

---

## 6. 使用例

### トークンステータス確認
```bash
curl http://localhost:3000/api/instagram/tokens/status | jq .
```

### トークン手動延長
```bash
curl -X POST http://localhost:3000/api/instagram/tokens/refresh/899089366611951 | jq .
```

### 全トークン一括延長
```bash
curl -X POST http://localhost:3000/api/instagram/tokens/refresh-all | jq .
```

---

## 7. 動作確認結果

### スケジューラー起動ログ
```
[TokenScheduler] Started. Checking every 24 hours.
[TokenScheduler] Checking for expiring tokens (within 30 days)...
[TokenScheduler] No expiring tokens found.
```

### トークン延長テスト
```json
{
  "success": true,
  "message": "Token refreshed successfully",
  "data": {
    "facebookPageId": "899089366611951",
    "facebookPageName": "Ai-cat.fun",
    "instagramUsername": "aicatda",
    "tokenExpiresAt": "2026-01-21T07:22:41.341Z",
    "previousExpiry": "2026-01-21T06:15:28.470Z"
  }
}
```

---

## 8. 今後の課題

- [ ] トークン期限切れ通知（メール/Slack等）
- [ ] WordPress プラグインとの連携テスト
- [ ] 本番環境へのデプロイ
- [ ] Meta App Review（本番公開時）

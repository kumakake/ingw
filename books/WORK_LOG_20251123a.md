# 本番環境セットアップ作業ログ (2025-11-23)

## 概要

Instagram OAuth サービスの本番環境セットアップを実施。

## 環境情報

- **ドメイン**: ingw.ai-trans-labo.fun
- **ポート**: 3036
- **Webサーバー**: nginx (SSL設定済み)
- **プロセス管理**: PM2
- **データベース**: PostgreSQL

---

## 1. nginx 設定

### 作成ファイル

`nginx.conf` を作成。

### 主な設定内容

- HTTP → HTTPS リダイレクト
- リバースプロキシ (localhost:3036)
- SSL/TLS設定 (TLS 1.2/1.3)
- セキュリティヘッダー

### SSL設定

```nginx
ssl_protocols TLSv1.2 TLSv1.3;
ssl_ciphers HIGH:!aNULL:!MD5;
ssl_prefer_server_ciphers on;
```

### セキュリティヘッダー

| ヘッダー | 値 | 目的 |
|----------|-----|------|
| X-Frame-Options | SAMEORIGIN | クリックジャッキング防止 |
| X-Content-Type-Options | nosniff | MIMEスニッフィング防止 |
| X-XSS-Protection | 1; mode=block | XSS攻撃防止 |
| Strict-Transport-Security | max-age=63072000 | HSTS有効化 |

### 解決した問題

- `ssl_session_cache shared:SSL:50m` が他の設定と競合 → 削除して既存キャッシュを使用

---

## 2. PostgreSQL 設定

### データベース・ユーザー作成

```sql
-- ユーザー作成
CREATE USER adm_instagw WITH ENCRYPTED PASSWORD 'pP4gz81AkDiaeaTb';

-- データベース作成
CREATE DATABASE instagram_oauth_db OWNER adm_instagw;
```

### スキーマ適用

```bash
psql -U adm_instagw -d instagram_oauth_db -h localhost -f db/schema.sql
```

### 作成されたテーブル

- `instagram_users` - Instagram Business Account情報
- `licenses` - プラグインライセンス管理

---

## 3. PM2 設定

### ecosystem.config.js

```javascript
module.exports = {
  apps: [
    {
      name               : 'in-gateway-api',
      script             : 'src/app.js',
      instances          : 1,
      autorestart        : true,
      watch              : false,
      max_memory_restart : '256M',
      env: {  // env_production から env に変更
        NODE_ENV            : 'production',
        PORT                : 3036,
        DB_HOST             : 'localhost',
        DB_PORT             : 5432,
        DB_NAME             : 'instagram_oauth_db',
        DB_USER             : 'adm_instagw',
        DB_PASSWORD         : '***',
        FACEBOOK_APP_ID     : '***',
        FACEBOOK_APP_SECRET : '***',
        REDIRECT_URI        : 'https://ingw.ai-trans-labo.fun/auth/callback',
        ALLOWED_ORIGINS     : 'https://ingw.ai-trans-labo.fun',
        SESSION_SECRET      : '***',
      },
      error_file      : './logs/error.log',
      out_file        : './logs/out.log',
      log_date_format : 'YYYY-MM-DD HH:mm:ss Z',
      merge_logs      : true,
    },
  ],
};
```

### 起動コマンド

```bash
pm2 start ecosystem.config.js
```

### PM2 メモ: `env` vs `env_production`

| 設定 | 起動コマンド | 用途 |
|------|-------------|------|
| `env` | `pm2 start ecosystem.config.js` | 単一環境向け（シンプル） |
| `env_production` | `pm2 start ecosystem.config.js --env production` | 複数環境切り替え用 |

**結論**: 開発環境は docker-compose、本番は PM2 と分離しているため、`env` でシンプルに運用。

### 設定変更時の注意

`pm2 restart` では設定変更が反映されない。変更後は：

```bash
pm2 delete in-gateway-api
pm2 start ecosystem.config.js
```

---

## 4. 動作確認

### 確認URL

- **トップページ**: https://ingw.ai-trans-labo.fun/
- **ライセンス管理**: https://ingw.ai-trans-labo.fun/license.html

### ステータス

| 項目 | 状態 |
|------|------|
| PostgreSQL | 完了 |
| PM2 起動 | 完了 |
| nginx 設定 | 作成済み（反映は未確認） |
| ライセンス管理画面 | 動作確認済み |

---

## 残作業

- nginx 設定の本番反映確認
- OAuth フロー動作確認
- WordPress プラグインとの連携テスト

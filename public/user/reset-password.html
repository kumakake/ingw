<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®š - Instagram OAuth Service</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body class="auth-page">
  <div id="header"></div>
  
  <div class="auth-container">
    <div class="auth-card card">
      <div class="auth-header">
        <div class="auth-logo">ğŸ”</div>
        <h1 class="auth-title">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®š</h1>
        <p class="auth-subtitle">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
      </div>
      
      <div id="messageContainer"></div>
      
      <div id="loadingSection">
        <p class="text-center">ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼ä¸­...</p>
      </div>
      
      <div id="errorSection" style="display: none;">
        <div class="message message-error">
          <p id="errorMessage"></p>
        </div>
        <div class="text-center mt-4">
          <a href="/user/forgot-password" class="btn btn-primary">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã‚’ã‚„ã‚Šç›´ã™</a>
        </div>
      </div>
      
      <div id="formSection" style="display: none;">
        <div class="message message-info mb-4">
          <strong>ãƒ­ã‚°ã‚¤ãƒ³ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ:</strong> <span id="accountDisplay"></span>
        </div>
        
        <form id="resetForm" onsubmit="handleReset(event)">
          <div class="form-group">
            <label for="newPassword">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
            <input type="password" id="newPassword" class="form-input" required 
                   placeholder="12æ–‡å­—ä»¥ä¸Š" minlength="12">
            <small class="form-hint">12æ–‡å­—ä»¥ä¸Šã€è‹±å¤§æ–‡å­—ãƒ»è‹±å°æ–‡å­—ãƒ»æ•°å­—ã‚’å«ã‚€</small>
          </div>
          
          <div class="form-group">
            <label for="confirmPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰</label>
            <input type="password" id="confirmPassword" class="form-input" required 
                   placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å†å…¥åŠ›" minlength="12">
          </div>
          
          <button type="submit" class="btn btn-primary btn-lg" style="width: 100%;" id="submitBtn">
            ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´
          </button>
        </form>
      </div>
      
      <div id="successSection" style="display: none;">
        <div class="message message-success">
          <p><strong>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸï¼</strong></p>
          <p>æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚</p>
        </div>
        <div class="text-center mt-4">
          <a href="/user/login" class="btn btn-primary btn-lg">ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸</a>
        </div>
      </div>
    </div>
  </div>
  
  <script src="/js/common.js"></script>
  <script>
    let resetToken = null;
    
    // Get token from URL
    const urlParams = new URLSearchParams(window.location.search);
    resetToken = urlParams.get('token');
    
    if (!resetToken) {
      showError('URLãŒç„¡åŠ¹ã§ã™ã€‚ãƒ¡ãƒ¼ãƒ«ã®ãƒªãƒ³ã‚¯ã‹ã‚‰å†åº¦ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚');
    } else {
      verifyToken();
    }
    
    async function verifyToken() {
      try {
        const response = await fetch(`/api/user/verify-reset-token/${resetToken}`);
        const data = await response.json();
        
        if (data.success) {
          document.getElementById('loadingSection').style.display = 'none';
          document.getElementById('formSection').style.display = 'block';
          document.getElementById('accountDisplay').textContent = data.loginAccount;
        } else {
          showError(data.error || 'ãƒˆãƒ¼ã‚¯ãƒ³ã®æ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      } catch (error) {
        showError('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      }
    }
    
    function showError(message) {
      document.getElementById('loadingSection').style.display = 'none';
      document.getElementById('errorSection').style.display = 'block';
      document.getElementById('errorMessage').textContent = message;
    }
    
    function validatePassword(password) {
      if (password.length < 12) {
        return 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯12æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„';
      }
      if (!/[a-z]/.test(password)) {
        return 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã«ã¯å°æ–‡å­—ã‚’å«ã‚ã¦ãã ã•ã„';
      }
      if (!/[A-Z]/.test(password)) {
        return 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã«ã¯å¤§æ–‡å­—ã‚’å«ã‚ã¦ãã ã•ã„';
      }
      if (!/[0-9]/.test(password)) {
        return 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã«ã¯æ•°å­—ã‚’å«ã‚ã¦ãã ã•ã„';
      }
      return null;
    }
    
    async function handleReset(e) {
      e.preventDefault();
      
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const submitBtn = document.getElementById('submitBtn');
      
      // Validate password
      const passwordError = validatePassword(newPassword);
      if (passwordError) {
        showMessage(passwordError, 'error');
        return;
      }
      
      // Check password match
      if (newPassword !== confirmPassword) {
        showMessage('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“', 'error');
        return;
      }
      
      submitBtn.disabled = true;
      submitBtn.textContent = 'å¤‰æ›´ä¸­...';
      
      try {
        const response = await fetch('/api/user/reset-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            token: resetToken,
            newPassword
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          document.getElementById('formSection').style.display = 'none';
          document.getElementById('successSection').style.display = 'block';
        } else {
          showMessage(data.error || 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
          submitBtn.disabled = false;
          submitBtn.textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´';
        }
      } catch (error) {
        showMessage('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´';
      }
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>InstaBridge - ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ç™»éŒ²</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body class="auth-page">
  <div id="header"></div>
  
  <div class="auth-container">
    <div class="auth-card card">
      <div class="auth-header">
        <div class="auth-logo">ğŸ“</div>
        <h1 class="auth-title">ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ç™»éŒ²</h1>
        <p class="auth-subtitle">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã‚’è¨­å®šã—ã¦ãã ã•ã„</p>
      </div>
      
      <div id="messageContainer"></div>
      
      <div id="loadingSection">
        <p class="text-center">ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼ä¸­...</p>
      </div>
      
      <div id="errorSection" style="display: none;">
        <div class="message message-error">
          <p id="errorMessage"></p>
        </div>
        <div class="text-center mt-4">
          <a href="/user/send-verification" class="btn btn-primary">æ–°è¦ç™»éŒ²ã‚’ã‚„ã‚Šç›´ã™</a>
        </div>
      </div>
      
      <div id="formSection" style="display: none;">
        <div class="message message-info mb-4">
          <strong>ç™»éŒ²ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹:</strong> <span id="emailDisplay"></span>
        </div>
        
        <form id="registerForm" onsubmit="handleRegister(event)">
          <div class="form-group">
            <label for="loginAccount">ãƒ­ã‚°ã‚¤ãƒ³ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</label>
            <input type="text" id="loginAccount" class="form-input" required 
                   placeholder="åŠè§’è‹±æ•°å­—ã€ãƒã‚¤ãƒ•ãƒ³ã€ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢"
                   pattern="[a-zA-Z0-9_-]+" minlength="3">
            <small class="form-hint">3æ–‡å­—ä»¥ä¸Šã€åŠè§’è‹±æ•°å­—ãƒ»ãƒã‚¤ãƒ•ãƒ³ãƒ»ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã®ã¿ä½¿ç”¨å¯</small>
          </div>
          
          <div class="form-group">
            <label for="password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
            <input type="password" id="password" class="form-input" required 
                   placeholder="12æ–‡å­—ä»¥ä¸Š" minlength="12">
            <small class="form-hint">12æ–‡å­—ä»¥ä¸Šã€è‹±å¤§æ–‡å­—ãƒ»è‹±å°æ–‡å­—ãƒ»æ•°å­—ã‚’å«ã‚€</small>
          </div>
          
          <div class="form-group">
            <label for="confirmPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰</label>
            <input type="password" id="confirmPassword" class="form-input" required 
                   placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å†å…¥åŠ›" minlength="12">
          </div>
          
          <button type="submit" class="btn btn-primary btn-lg" style="width: 100%;" id="submitBtn">
            ç™»éŒ²ã‚’å®Œäº†ã™ã‚‹
          </button>
        </form>
      </div>
      
      <div id="successSection" style="display: none;">
        <div class="message message-success">
          <p><strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼</strong></p>
          <p>ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚</p>
        </div>
        <div class="text-center mt-4">
          <a href="/user/login" class="btn btn-primary btn-lg">ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸</a>
        </div>
      </div>
    </div>
  </div>
  
  <script src="/js/common.js"></script>
  <script>
    let verificationToken = null;
    
    // Get token from URL
    const urlParams = new URLSearchParams(window.location.search);
    verificationToken = urlParams.get('token');
    
    if (!verificationToken) {
      showError('URLãŒç„¡åŠ¹ã§ã™ã€‚ãƒ¡ãƒ¼ãƒ«ã®ãƒªãƒ³ã‚¯ã‹ã‚‰å†åº¦ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚');
    } else {
      verifyToken();
    }
    
    async function verifyToken() {
      try {
        const response = await fetch(`/api/user/verify-email/${verificationToken}`);
        const data = await response.json();
        
        if (data.success) {
          document.getElementById('loadingSection').style.display = 'none';
          document.getElementById('formSection').style.display = 'block';
          document.getElementById('emailDisplay').textContent = data.email;
        } else {
          showError(data.error || 'ãƒˆãƒ¼ã‚¯ãƒ³ã®æ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      } catch (error) {
        showError('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      }
    }
    
    function showError(message) {
      document.getElementById('loadingSection').style.display = 'none';
      document.getElementById('errorSection').style.display = 'block';
      document.getElementById('errorMessage').textContent = message;
    }
    
    function validatePassword(password) {
      if (password.length < 12) {
        return 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯12æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„';
      }
      if (!/[a-z]/.test(password)) {
        return 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã«ã¯å°æ–‡å­—ã‚’å«ã‚ã¦ãã ã•ã„';
      }
      if (!/[A-Z]/.test(password)) {
        return 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã«ã¯å¤§æ–‡å­—ã‚’å«ã‚ã¦ãã ã•ã„';
      }
      if (!/[0-9]/.test(password)) {
        return 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã«ã¯æ•°å­—ã‚’å«ã‚ã¦ãã ã•ã„';
      }
      return null;
    }
    
    async function handleRegister(e) {
      e.preventDefault();
      
      const loginAccount = document.getElementById('loginAccount').value;
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const submitBtn = document.getElementById('submitBtn');
      
      // Validate password
      const passwordError = validatePassword(password);
      if (passwordError) {
        showMessage(passwordError, 'error');
        return;
      }
      
      // Check password match
      if (password !== confirmPassword) {
        showMessage('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“', 'error');
        return;
      }
      
      submitBtn.disabled = true;
      submitBtn.textContent = 'ç™»éŒ²ä¸­...';
      
      try {
        const response = await fetch('/api/user/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            token: verificationToken,
            loginAccount,
            password
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          document.getElementById('formSection').style.display = 'none';
          document.getElementById('successSection').style.display = 'block';
        } else {
          showMessage(data.error || 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
          submitBtn.disabled = false;
          submitBtn.textContent = 'ç™»éŒ²ã‚’å®Œäº†ã™ã‚‹';
        }
      } catch (error) {
        showMessage('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'ç™»éŒ²ã‚’å®Œäº†ã™ã‚‹';
      }
    }
  </script>
</body>
</html>

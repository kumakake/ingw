<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ライセンス管理 - IN-Gateway</title>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .nav-link {
            color: #667eea;
            text-decoration: none;
            font-size: 14px;
            margin-bottom: 20px;
            display: inline-block;
        }

        .nav-link:hover {
            text-decoration: underline;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            color: #333;
            font-size: 20px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 28px;
            font-weight: 700;
            color: #667eea;
        }

        .stat-label {
            font-size: 11px;
            color: #666;
            margin-top: 5px;
        }

        /* DataTables カスタマイズ */
        .dataTables_wrapper {
            font-size: 14px;
        }

        table.dataTable {
            width: 100% !important;
        }

        table.dataTable thead th {
            background: #667eea;
            color: white;
            font-weight: 600;
            padding: 12px 10px;
        }

        table.dataTable tbody td {
            padding: 10px;
            vertical-align: middle;
        }

        table.dataTable tbody tr:hover {
            background-color: #f5f5f5 !important;
        }

        .license-key {
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            letter-spacing: 0.5px;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .status-unused {
            background: #fff3cd;
            color: #856404;
        }

        .subscription-active {
            background: #d4edda;
            color: #155724;
        }

        .subscription-trialing {
            background: #cce5ff;
            color: #004085;
        }

        .subscription-canceled {
            background: #f8d7da;
            color: #721c24;
        }

        .subscription-past_due {
            background: #fff3cd;
            color: #856404;
        }

        .subscription-none {
            background: #e9ecef;
            color: #6c757d;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .copy-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
        }

        .copy-btn:hover {
            background: #5a6268;
        }

        /* 発行フォーム */
        .generate-form {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            flex-wrap: wrap;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-size: 12px;
            font-weight: 600;
            color: #555;
        }

        .form-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            width: 150px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* モーダル */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
        }

        .modal h3 {
            margin-bottom: 20px;
            color: #333;
        }

        .modal .form-group {
            margin-bottom: 15px;
        }

        .modal .form-group input {
            width: 100%;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            color: #666;
            font-size: 12px;
        }

        .editable {
            cursor: pointer;
            padding: 2px 5px;
            border-radius: 4px;
        }

        .editable:hover {
            background: #e9ecef;
        }

        .editable.empty {
            color: #999;
            font-style: italic;
        }

        /* 投稿ログモーダル */
        .modal-large {
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-large h3 {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .close-btn:hover {
            color: #333;
        }

        .attempts-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .attempts-stat {
            text-align: center;
        }

        .attempts-stat-number {
            font-size: 24px;
            font-weight: 700;
        }

        .attempts-stat-number.success { color: #27ae60; }
        .attempts-stat-number.failed { color: #e74c3c; }
        .attempts-stat-number.warning { color: #f39c12; }
        .attempts-stat-number.info { color: #3498db; }

        .attempts-stat-label {
            font-size: 10px;
            color: #666;
        }

        .attempts-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .attempts-table th {
            background: #667eea;
            color: white;
            padding: 8px;
            text-align: left;
        }

        .attempts-table td {
            padding: 8px;
            border-bottom: 1px solid #eee;
        }

        .attempts-table tr:hover {
            background: #f8f9fa;
        }

        .status-success { color: #27ae60; font-weight: 600; }
        .status-failed { color: #e74c3c; font-weight: 600; }
        .status-rate_limited { color: #f39c12; font-weight: 600; }
        .status-token_expired { color: #9b59b6; font-weight: 600; }
        .status-container_error { color: #e67e22; font-weight: 600; }
        .status-publish_error { color: #c0392b; font-weight: 600; }

        .quota-bar {
            width: 100px;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            display: inline-block;
            vertical-align: middle;
            margin-left: 5px;
        }

        .quota-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }

        .quota-bar-fill.low { background: #27ae60; }
        .quota-bar-fill.medium { background: #f39c12; }
        .quota-bar-fill.high { background: #e74c3c; }

        .btn-info {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }

        .error-message-cell {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .error-message-cell:hover {
            white-space: normal;
            word-break: break-all;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .tab-buttons {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }

        .tab-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
            font-size: 13px;
        }

        .tab-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="nav-link">&larr; OAuth画面に戻る</a>

        <h1>ライセンス管理</h1>
        <p class="subtitle">IN-Gateway プラグイン用ライセンスの発行・管理</p>

        <div id="message-container"></div>

        <!-- 統計 -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="stat-total">-</div>
                <div class="stat-label">発行数/ユーザー数</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="stat-active">-</div>
                <div class="stat-label">有効</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="stat-activated">-</div>
                <div class="stat-label">使用中</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="stat-unused">-</div>
                <div class="stat-label">未使用</div>
            </div>
        </div>

        <!-- ライセンス発行フォーム -->
        <div class="section">
            <h2>新規ライセンス発行</h2>
            <div class="generate-form">
                <p style="color: #666; margin-bottom: 15px;">※利用者No・利用者氏名はユーザー登録時に自動設定されます</p>
                <button class="btn" id="generate-btn" onclick="generateLicense()">
                    ライセンスを発行
                </button>
            </div>
        </div>

        <!-- ライセンス一覧 -->
        <div class="section">
            <h2>ライセンス一覧</h2>
            <table id="licenses-table" class="display" style="width:100%">
                <thead>
                    <tr>
                        <th>利用者No</th>
                        <th>利用者氏名</th>
                        <th>ライセンスキー</th>
                        <th>ドメイン</th>
                        <th style="width:50px">状態</th>
                        <th>契約状態</th>
                        <th>契約更新日</th>
                        <th>発行日</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

        <div class="footer">
            <p>IN-Gateway License Management v1.0</p>
        </div>
    </div>

    <!-- 投稿ログモーダル -->
    <div class="modal-overlay" id="attempts-modal">
        <div class="modal modal-large">
            <h3>
                <span>投稿ログ - <span id="modal-user-name">-</span></span>
                <button class="close-btn" onclick="closeAttemptsModal()">&times;</button>
            </h3>

            <!-- 統計 -->
            <div class="attempts-stats" id="attempts-stats">
                <div class="attempts-stat">
                    <div class="attempts-stat-number info" id="attempts-total">-</div>
                    <div class="attempts-stat-label">合計</div>
                </div>
                <div class="attempts-stat">
                    <div class="attempts-stat-number success" id="attempts-success">-</div>
                    <div class="attempts-stat-label">成功</div>
                </div>
                <div class="attempts-stat">
                    <div class="attempts-stat-number failed" id="attempts-failed">-</div>
                    <div class="attempts-stat-label">失敗</div>
                </div>
                <div class="attempts-stat">
                    <div class="attempts-stat-number warning" id="attempts-rate-limit">-</div>
                    <div class="attempts-stat-label">制限超過</div>
                </div>
                <div class="attempts-stat">
                    <div class="attempts-stat-number info" id="attempts-success-rate">-</div>
                    <div class="attempts-stat-label">成功率</div>
                </div>
                <div class="attempts-stat">
                    <div class="attempts-stat-number warning" id="attempts-quota">-</div>
                    <div class="attempts-stat-label">最大使用数</div>
                </div>
            </div>

            <!-- タブ -->
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchTab('log')">投稿履歴</button>
                <button class="tab-btn" onclick="switchTab('errors')">エラー傾向</button>
            </div>

            <!-- 投稿履歴タブ -->
            <div class="tab-content active" id="tab-log">
                <table class="attempts-table">
                    <thead>
                        <tr>
                            <th>日時</th>
                            <th>ステータス</th>
                            <th>使用数</th>
                            <th>エラーコード</th>
                            <th>エラーメッセージ</th>
                        </tr>
                    </thead>
                    <tbody id="attempts-tbody">
                    </tbody>
                </table>
            </div>

            <!-- エラー傾向タブ -->
            <div class="tab-content" id="tab-errors">
                <table class="attempts-table">
                    <thead>
                        <tr>
                            <th>エラーコード</th>
                            <th>エラーメッセージ</th>
                            <th>発生回数</th>
                            <th>最終発生</th>
                        </tr>
                    </thead>
                    <tbody id="errors-tbody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>


    <script>
        const API_BASE = '/api/license';
        let dataTable;

        function showMessage(message, type = 'error') {
            const container = document.getElementById('message-container');
            const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
            container.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
            setTimeout(() => { container.innerHTML = ''; }, 5000);
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showMessage('クリップボードにコピーしました', 'success');
            });
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        function getStatusBadge(user) {
            // ライセンス未発行の場合
            if (!user.licenseKey) {
                return '<span class="status-badge" style="background: #6c757d;">未発行</span>';
            }
            if (!user.isActive) {
                return '<span class="status-badge status-inactive">無効</span>';
            } else if (user.domain) {
                return '<span class="status-badge status-active">使用中</span>';
            } else {
                return '<span class="status-badge status-unused">未使用</span>';
            }
        }

        function getSubscriptionBadge(status) {
            const labels = {
                'active': '有効',
                'trialing': 'トライアル',
                'canceled': '解約済み',
                'past_due': '支払遅延',
                'unpaid': '未払い',
                'none': '未契約'
            };
            const statusKey = status || 'none';
            const label = labels[statusKey] || '未契約';
            const cssClass = statusKey === 'unpaid' ? 'past_due' : statusKey;
            return `<span class="status-badge subscription-${cssClass}">${label}</span>`;
        }

        function getActionButtons(user) {
            // ライセンス未発行の場合
            if (!user.licenseKey) {
                return '<span style="color: #999;">-</span>';
            }

            let buttons = `<button class="copy-btn" onclick="copyToClipboard('${user.licenseKey}')">コピー</button>`;

            // 投稿ログボタン（ライセンスIDがある場合のみ）
            if (user.licenseId) {
                buttons += `<button class="btn btn-info btn-sm" onclick="showAttempts(${user.licenseId}, '${user.userName || user.userNo}')">投稿ログ</button>`;
            }

            if (user.domain) {
                buttons += `<button class="btn btn-warning btn-sm" onclick="resetLicense('${user.licenseKey}')">リセット</button>`;
            }
            if (user.isActive) {
                buttons += `<button class="btn btn-danger btn-sm" onclick="deactivateLicense('${user.licenseKey}')">無効化</button>`;
            }
            // 未使用（ドメイン未登録）の場合のみ削除ボタンを表示
            if (!user.domain) {
                buttons += `<button class="btn btn-danger btn-sm" onclick="deleteLicense('${user.licenseKey}')" style="background: #343a40;">削除</button>`;
            }
            return `<div class="action-buttons">${buttons}</div>`;
        }

        async function loadLicenses() {
            try {
                const response = await fetch(`${API_BASE}/list`);
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error);
                }

                const licenses = result.data;
                updateStats(licenses);
                updateTable(licenses);
            } catch (error) {
                showMessage('ライセンス一覧の取得に失敗しました: ' + error.message, 'error');
            }
        }

        function updateStats(users) {
            const totalUsers = users.length;
            const withLicense = users.filter(u => u.licenseKey);
            const total = withLicense.length;
            const active = withLicense.filter(u => u.isActive).length;
            const activated = withLicense.filter(u => u.domain).length;
            const unused = withLicense.filter(u => u.isActive && !u.domain).length;

            document.getElementById('stat-total').textContent = `${total} / ${totalUsers}`;
            document.getElementById('stat-active').textContent = active;
            document.getElementById('stat-activated').textContent = activated;
            document.getElementById('stat-unused').textContent = unused;
        }

        function updateTable(users) {
            const tableData = users.map(u => [
                u.userNo || '<span class="editable empty">未設定</span>',
                u.userName || '<span class="editable empty">未設定</span>',
                u.licenseKey ? `<span class="license-key">${u.licenseKey}</span>` : '<span style="color: #999;">未発行</span>',
                u.domain || '-',
                getStatusBadge(u),
                getSubscriptionBadge(u.subscriptionStatus),
                formatDate(u.subscriptionPeriodEnd),
                formatDate(u.licenseKey ? u.licenseCreatedAt : u.userCreatedAt),
                getActionButtons(u)
            ]);

            if (dataTable) {
                dataTable.clear();
                dataTable.rows.add(tableData);
                dataTable.draw();
            }
        }

        async function generateLicense() {
            const btn = document.getElementById('generate-btn');

            btn.disabled = true;
            btn.textContent = '発行中...';

            try {
                const response = await fetch(`${API_BASE}/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error);
                }

                showMessage(`ライセンスを発行しました: ${result.data.licenseKey}`, 'success');
                loadLicenses();
            } catch (error) {
                showMessage('発行エラー: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'ライセンスを発行';
            }
        }

        async function deactivateLicense(licenseKey) {
            if (!confirm(`ライセンスを無効化しますか？\nこの操作は取り消せません。`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/deactivate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ license_key: licenseKey })
                });
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error);
                }

                showMessage('ライセンスを無効化しました', 'success');
                loadLicenses();
            } catch (error) {
                showMessage('無効化エラー: ' + error.message, 'error');
            }
        }

        async function resetLicense(licenseKey) {
            if (!confirm(`ドメイン登録をリセットしますか？\n別のサイトで再利用できるようになります。`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/reset`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ license_key: licenseKey })
                });
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error);
                }

                showMessage('ドメイン登録をリセットしました', 'success');
                loadLicenses();
            } catch (error) {
                showMessage('リセットエラー: ' + error.message, 'error');
            }
        }

        async function deleteLicense(licenseKey) {
            if (!confirm(`このライセンスを削除しますか？\nこの操作は取り消せません。`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/delete`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ license_key: licenseKey })
                });
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error);
                }

                showMessage('ライセンスを削除しました', 'success');
                loadLicenses();
            } catch (error) {
                showMessage('削除エラー: ' + error.message, 'error');
            }
        }

        // ========== 投稿ログモーダル関連 ==========

        let currentLicenseId = null;

        async function showAttempts(licenseId, userName) {
            currentLicenseId = licenseId;
            document.getElementById('modal-user-name').textContent = userName || '-';
            document.getElementById('attempts-modal').classList.add('active');

            // 統計とログを並行取得
            await Promise.all([
                loadAttemptsStats(licenseId),
                loadAttempts(licenseId),
                loadErrorTrends()
            ]);
        }

        function closeAttemptsModal() {
            document.getElementById('attempts-modal').classList.remove('active');
            currentLicenseId = null;
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        async function loadAttemptsStats(licenseId) {
            try {
                const response = await fetch(`${API_BASE}/attempts-stats/${licenseId}?hours=24`);
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error);
                }

                const stats = result.data;
                document.getElementById('attempts-total').textContent = stats.total;
                document.getElementById('attempts-success').textContent = stats.success;
                document.getElementById('attempts-failed').textContent = stats.failed + stats.containerError + stats.publishError;
                document.getElementById('attempts-rate-limit').textContent = stats.rateLimited;
                document.getElementById('attempts-success-rate').textContent = stats.successRate + '%';
                document.getElementById('attempts-quota').textContent = stats.maxQuotaUsage + '/25';
            } catch (error) {
                console.error('Failed to load attempts stats:', error);
            }
        }

        async function loadAttempts(licenseId) {
            try {
                const response = await fetch(`${API_BASE}/attempts/${licenseId}?limit=50`);
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error);
                }

                const tbody = document.getElementById('attempts-tbody');

                if (result.data.items.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="no-data">投稿ログがありません</td></tr>';
                    return;
                }

                tbody.innerHTML = result.data.items.map(a => {
                    const statusLabel = getStatusLabel(a.status);
                    const quotaHtml = a.quotaUsage !== null ? getQuotaHtml(a.quotaUsage, a.quotaTotal || 25) : '-';
                    const dateStr = formatDateTime(a.createdAt);

                    return `<tr>
                        <td>${dateStr}</td>
                        <td><span class="status-${a.status}">${statusLabel}</span></td>
                        <td>${quotaHtml}</td>
                        <td>${a.errorCode || '-'}</td>
                        <td class="error-message-cell" title="${a.errorMessage || ''}">${a.errorMessage || '-'}</td>
                    </tr>`;
                }).join('');
            } catch (error) {
                console.error('Failed to load attempts:', error);
                document.getElementById('attempts-tbody').innerHTML =
                    '<tr><td colspan="5" class="no-data">データの取得に失敗しました</td></tr>';
            }
        }

        async function loadErrorTrends() {
            try {
                const response = await fetch(`${API_BASE}/error-trends?hours=24`);
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error);
                }

                const tbody = document.getElementById('errors-tbody');

                if (result.data.errors.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="no-data">直近24時間のエラーはありません</td></tr>';
                    return;
                }

                tbody.innerHTML = result.data.errors.map(e => `<tr>
                    <td><span class="status-failed">${e.errorCode || '-'}</span></td>
                    <td class="error-message-cell" title="${e.errorMessage || ''}">${e.errorMessage || '-'}</td>
                    <td style="font-weight:600">${e.count}</td>
                    <td>${formatDateTime(e.lastOccurred)}</td>
                </tr>`).join('');
            } catch (error) {
                console.error('Failed to load error trends:', error);
            }
        }

        function getStatusLabel(status) {
            const labels = {
                'success': '成功',
                'failed': '失敗',
                'rate_limited': '制限超過',
                'token_expired': 'トークン期限切れ',
                'container_error': 'コンテナエラー',
                'publish_error': '公開エラー'
            };
            return labels[status] || status;
        }

        function getQuotaHtml(usage, total) {
            const percent = Math.round((usage / total) * 100);
            let colorClass = 'low';
            if (percent >= 80) colorClass = 'high';
            else if (percent >= 50) colorClass = 'medium';

            return `${usage}/${total}
                <div class="quota-bar">
                    <div class="quota-bar-fill ${colorClass}" style="width: ${percent}%"></div>
                </div>`;
        }

        function formatDateTime(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // 初期化
        $(document).ready(function() {
            dataTable = $('#licenses-table').DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/ja.json'
                },
                order: [[7, 'desc']],
                pageLength: 25,
                lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "全て"]],
                columnDefs: [
                    { orderable: false, targets: 8 }
                ]
            });

            loadLicenses();

            // モーダル外クリックで閉じる
            document.getElementById('attempts-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeAttemptsModal();
                }
            });
        });
    </script>
</body>
</html>
